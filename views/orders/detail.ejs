<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Order Status Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-receipt me-2"></i>
                            Pedido #<%= order.numero_pedido %>
                        </h5>
                        <span class="badge bg-<%= order.estado === 'pendiente' ? 'warning' : 
                                               order.estado === 'pendiente_pago' ? 'warning' :
                                               order.estado === 'confirmado' ? 'info' : 
                                               order.estado === 'preparando' ? 'primary' : 
                                               order.estado === 'en_camino' ? 'info' : 
                                               order.estado === 'entregado' ? 'success' : 
                                               order.estado === 'cancelado' ? 'danger' : 'secondary' %>">
                            <% if (order.estado === 'pendiente_pago') { %>
                              Pendiente de Pago
                            <% } else { %>
                              <%= order.estado.charAt(0).toUpperCase() + order.estado.slice(1).replace('_', ' ') %>
                            <% } %>
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Restaurant Info -->
                    <div class="restaurant-info mb-4 p-3 bg-light rounded">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-store text-primary fs-4 me-3"></i>
                            <div>
                                <h6 class="mb-1"><%= restaurant && restaurant.nombre ? restaurant.nombre : 'Restaurante no disponible' %></h6>
                                <small class="text-muted">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    <%= restaurant && restaurant.direccion ? restaurant.direccion : 'Dirección no disponible' %>
                                </small>
                                
                            </div>
                        </div>
                    </div>

                    <% if (order.estado === 'en_camino' && order.repartidor_id) { %>
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <i class="fas fa-map-marker-alt me-2"></i> Seguimiento de tu Pedido
                            </div>
                            <div class="card-body">
                                <p>Tu repartidor <strong><%= order.repartidor_nombre %></strong> está en camino con tu pedido.</p>
                                <div id="deliveryMap" style="height: 300px; width: 100%;"></div>
                                <p class="mt-2 text-muted text-center" id="driver-location-status">Cargando ubicación del repartidor...</p>
                            </div>
                        </div>
                    <% } %>

                    <!-- Order Items -->
                    <div class="order-items mb-4">
                        <h6 class="mb-3">Productos</h6>
                        <% if (items && items.length > 0) { %>
                            <% items.forEach(item => { %>
                                <div class="order-item d-flex align-items-center mb-3 p-3 border rounded">
                                    <img src="<%= item.imagen.startsWith('/uploads/') ? item.imagen : '/uploads/' + (item.imagen || 'no-image.png') %>" 
                                         alt="<%= item.nombre || 'Producto' %>" 
                                         class="rounded me-3" width="80" height="80"
                                         style="object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1"><%= item.nombre || 'Producto sin nombre' %></h6>
                                        <% if (item.notas_especiales) { %>
                                            <small class="text-muted d-block mb-1">
                                                <i class="fas fa-comment-alt me-1"></i>
                                                <%= item.notas_especiales %>
                                            </small>
                                        <% } %>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted">Cantidad: <%= item.cantidad || 0 %></span>
                                            <strong>$<%= (Number(item.precio_unitario || 0) * Number(item.cantidad || 0)).toFixed(2) %></strong>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="alert alert-info">
                                No hay productos en este pedido
                            </div>
                        <% } %>
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary p-3 bg-light rounded">
                        <h6 class="mb-3">Resumen del Pedido</h6>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong>$<%= Number(order && order.subtotal ? order.subtotal : 0).toFixed(2) %></strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Envío:</span>
                            <strong><%= Number(order && order.costo_delivery ? order.costo_delivery : 0) > 0 ? `$${Number(order && order.costo_delivery ? order.costo_delivery : 0).toFixed(2)}` : 'Gratis' %></strong>
                        </div>
                        <% if (order && (order.metodo_pago === 'efectivo' || order.metodo_pago === 'transferencia')) { %>
                            <%
                                const originalTotal = Number(order.subtotal || 0) + Number(order.costo_delivery || 0);
                                const discountAmount = originalTotal - Number(order.total || 0);
                            %>
                            <div class="d-flex justify-content-between mb-2 text-success">
                                <span>Descuento:</span>
                                <strong>-$<%= discountAmount.toFixed(2) %></strong>
                            </div>
                        <% } %>
                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="fs-5">Total:</span>
                            <strong class="fs-5 text-primary">$<%= Number(order && order.total ? order.total : 0).toFixed(2) %></strong>
                        </div>
                    </div>

                    <!-- Delivery Info -->
                    <div class="delivery-info mt-4">
    <h6 class="mb-3">Información de Entrega</h6>
    <div class="p-3 bg-light rounded">
        <p class="mb-2">
            <i class="fas fa-map-marker-alt text-primary me-2"></i>
            <strong>Dirección:</strong> <%= order && order.direccion_entrega ? order.direccion_entrega : 'No disponible' %>
        </p>
        <% if (order && order.latitud_entrega && order.longitud_entrega) { %>
            <button class="btn btn-outline-success btn-sm mb-2" onclick="showOrderLocation('<%= order.latitud_entrega %>', '<%= order.longitud_entrega %>')">
                <i class="fas fa-map-marked-alt me-1"></i> Ver ubicación mejorada
            </button>
        <% } %>
        <% if (order && order.notas_especiales) { %>
            <p class="mb-0">
                <i class="fas fa-comment-alt text-primary me-2"></i>
                <strong>Notas:</strong> <%= order.notas_especiales %>
            </p>
        <% } %>
    </div>
</div>

                    <!-- Payment Info -->
                    <div class="payment-info mt-4">
                        <h6 class="mb-3">Información de Pago</h6>
<div class="p-3 bg-light rounded">
    <p class="mb-0">
        <i class="fas fa-credit-card text-primary me-2"></i>
        <strong>Método de Pago:</strong> 
        <%= order && order.metodo_pago ? 
            (order.metodo_pago === 'mercadopago' ? 'MercadoPago' :
             order.metodo_pago === 'efectivo' ? 'Efectivo' :
             order.metodo_pago === 'transferencia' ? 'Transferencia Bancaria' :
             order.metodo_pago) : 'No disponible' %>
    </p>
    <% if (order && order.metodo_pago === 'mercadopago') { %>
        <p class="mb-0 mt-2">
            <i class="fas fa-info-circle text-info me-2"></i>
            <strong>Estado del Pago:</strong>
            <% if (order.estado === 'confirmado' || order.estado === 'pagado') { %>
                <span class="badge bg-success">Pagado</span>
            <% } else if (order.estado === 'pendiente_pago') { %>
                <span class="badge bg-warning text-dark">Pendiente de pago</span>
            <% } else if (order.estado === 'cancelado') { %>
                <span class="badge bg-danger">Pago rechazado</span>
            <% } else { %>
                <span class="badge bg-secondary">Desconocido</span>
            <% } %>
        </p>
    <% } %>
                            <% if (order && order.metodo_pago === 'transferencia') { %>
                            <hr>
                            <h6 class="mt-3">Datos para Transferencia</h6>
                            <p class="mb-1"><strong>CBU/CVU:</strong> <%= restaurant.datos_transferencia_cbu %></p>
                            <p class="mb-1"><strong>Alias:</strong> <%= restaurant.datos_transferencia_alias %></p>
                            <p class="mb-1"><strong>Titular:</strong> <%= restaurant.datos_transferencia_titular %></p>
                            <p class="mb-2"><strong>DNI/CUIT:</strong> <%= restaurant.datos_transferencia_dni %></p>

                            <% if (!order.comprobante_pago_url) { %>
                            <form id="comprobanteForm" class="mt-3" enctype="multipart/form-data">
                                <input type="hidden" name="orderId" value="<%= order.id %>">
                                <div class="mb-3">
                                    <label for="comprobante" class="form-label">Subir Comprobante de Pago</label>
                                    <input type="file" class="form-control" id="comprobante" name="comprobante" accept="image/*,.pdf,.jpg,.jpeg,.png">
                                </div>
                                <button type="submit" class="btn" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; border: none;">Enviar Comprobante</button>
                            </form>
                            <% } else { %>
                            <div class="mt-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title mb-3">Comprobante de Pago Subido</h6>
                                        <div class="d-flex align-items-center">
                                            <a href="/uploads/comprobantes/<%= order.comprobante_pago_url %>" 
                                               target="_blank" 
                                               class="me-3">
                                                <img src="/uploads/comprobantes/<%= order.comprobante_pago_url %>" 
                                                     alt="Comprobante de pago" 
                                                     class="img-thumbnail" 
                                                     style="max-width: 200px;">
                                            </a>
                                            <div class="ms-3">
                                                <p class="mb-1">
                                                    <i class="fas fa-file-image text-primary me-2"></i>
                                                    <strong>Archivo:</strong> <%= order.comprobante_pago_url %>
                                                </p>
                                                <p class="mb-0">
                                                    <i class="fas fa-external-link-alt text-info me-2"></i>
                                                    <a href="/uploads/comprobantes/<%= order.comprobante_pago_url %>" 
                                                       target="_blank" 
                                                       class="text-decoration-none">
                                                        Ver en ventana nueva
                                                    </a>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                            <% } %>
                        </div>
                    </div>

                    <!-- Order Timeline -->
                    <div class="order-timeline mt-4">
                        <h6 class="mb-3">Estado del Pedido</h6>
                        
                        <% 
                          let showCompletePaymentButton = false;
                          if (order && order.estado === 'pendiente_pago') {
                            const orderTime = new Date(order.fecha_pedido);
                            const currentTime = new Date();
                            const minutesDiff = (currentTime - orderTime) / (1000 * 60);
                            if (minutesDiff <= 15) {
                              showCompletePaymentButton = true;
                            }
                          }
                        %>

                        <% if (showCompletePaymentButton) { %>
                          <div class="alert alert-warning mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                              <div>
                                <i class="fas fa-clock me-2"></i>
                                <strong>Pago Pendiente</strong>
                                <p class="mb-0 mt-1">Tu pedido está esperando que completes el pago. Tienes hasta 15 minutos para hacerlo.</p>
                              </div>
                              <a href="/orders/<%= order.id %>/complete-payment" class="btn btn-primary">
                                <i class="fas fa-credit-card me-2"></i>
                                Completar Pago
                              </a>
                            </div>
                          </div>
                        <% } %>
                        
                        <div class="timeline">
                            <% const estados = ['pendiente', 'confirmado', 'preparando', 'en_camino', 'entregado'] %>
                            <% estados.forEach((estado, index) => { %>
                                <div class="timeline-item d-flex mb-3">
                                    <div class="timeline-icon me-3">
                                        <div class="timeline-dot <%= order && order.estado === estado ? 'active' : 
                                                                   order && estados.indexOf(order.estado) > index ? 'completed' : '' %>">
                                            <i class="fas fa-<%= estado === 'pendiente' ? 'clock' :
                                                               estado === 'confirmado' ? 'check' :
                                                               estado === 'preparando' ? 'utensils' :
                                                               estado === 'en_camino' ? 'truck' :
                                                               'check-circle' %>"></i>
                                        </div>
                                        <% if (index < estados.length - 1) { %>
                                            <div class="timeline-line"></div>
                                        <% } %>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1"><%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %></h6>
                                        <small class="text-muted">
                                            <%= order && order.estado === estado ? 'Estado actual' :
                                               order && estados.indexOf(order.estado) > index ? 'Completado' :
                                               'Pendiente' %>
                                        </small>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between">
                <a href="/orders/history" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver a Mis Pedidos
                </a>
                <div class="d-flex gap-2">
                    <% if (canChat) { %>
                    <!-- Botón de Chat -->
                    <button class="btn btn-outline-info" 
                            id="openClientChatBtn"
                            data-order-id="<%= order.id %>"
                            title="Chat con el Restaurante">
                        <i class="fas fa-comments me-2"></i> Chat
                    </button>
                    <% } %>
                    <% if (order && order.estado === 'en_camino') { %>
                        <button id="markAsDeliveredBtn" data-order-id="<%= order.id %>" class="btn btn-success">
                            <i class="fas fa-check me-2"></i>
                            Marcar como Entregado
                        </button>
                    <% } %>
                    <% if (order && order.estado === 'pendiente') { %>
                        <button id="cancelOrderBtn" data-order-id="<%= order.id %>" class="btn btn-outline-danger">
                            <i class="fas fa-times me-2"></i>
                            Cancelar Pedido
                        </button>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
}

.timeline-item {
    position: relative;
}

.timeline-icon {
    position: relative;
    width: 40px;
    text-align: center;
}

.timeline-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
}

.timeline-dot.active {
    background: #0d6efd;
    color: white;
}

.timeline-dot.completed {
    background: #198754;
    color: white;
}

.timeline-line {
    position: absolute;
    left: 50%;
    top: 40px;
    bottom: -20px;
    width: 2px;
    background: #e9ecef;
    transform: translateX(-50%);
}

.timeline-item:last-child .timeline-line {
    display: none;
}

.timeline-content {
    flex: 1;
}

/* Estilos para el chat (copiar de order-details-restaurant.ejs o style.css) */
.chat-section .card {
    border-radius: 0.5rem;
    overflow: hidden;
}

.chat-section .chat-input {
    background-color: #f8f9fa;
}

.chat-section .chat-input input {
    border-radius: 1.5rem;
    padding: 0.5rem 1rem;
}

.chat-section .chat-input button {
    border-radius: 1.5rem;
    padding: 0.5rem 1.5rem;
}

.chat-section #chatMessages {
    background-color: #fff;
}

.chat-section #chatMessages .bg-primary {
    background-color: #0d6efd !important;
}

.chat-section #chatMessages .bg-light {
    background-color: #f8f9fa !important;
}

.chat-section #chatMessages .rounded {
    border-radius: 1rem !important;
}

.chat-section #chatMessages .ms-auto {
    margin-left: auto !important;
}
</style>

<!-- Modal de Detalles del Pedido (incluye el chat) -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Pedido #<%= order.numero_pedido %></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="clientChatModalBody">
                <!-- Aquí se cargará el contenido general del pedido si se usa dinámicamente, 
                     pero para el chat lo pondremos directamente si el modal se abre con el chat. -->
                <div class="chat-section">
                    <h6 class="mb-3">Chat del Pedido</h6>
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0 d-flex flex-column" style="height: 300px;">
                            <div id="chat-messages" class="p-3 overflow-auto flex-grow-1">
                                <!-- Los mensajes del chat se cargarán aquí -->
                                <div class="text-center text-muted py-5">Cargando mensajes...</div>
                            </div>
                            <form id="chat-form" class="chat-input border-top p-3 bg-light d-flex align-items-center">
                                <input type="text" 
                                       id="chat-message-input" 
                                       class="form-control me-2" 
                                       placeholder="Escribe un mensaje...">
                                <button type="submit" 
                                        class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Enviar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contenedor para variables de configuración JavaScript -->
<div id="app-config" 
     data-user-id="<%= user && user.id ? user.id : '' %>"
     data-user-type="<%= user && user.tipo_usuario ? user.tipo_usuario : '' %>"
     style="display: none;"></div>

<!-- Audio para notificaciones de chat -->
<audio id="chatNotificationSound" preload="auto" style="display: none;">
    <source src="https://cdn.jsdelivr.net/gh/soundkit/free-sound-effects@master/mp3/notification-sound-7062.mp3" type="audio/mpeg">
</audio>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>



<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<div id="order-status-data"
     data-order-id="<%= order.id %>"
     data-order-status="<%= order.estado %>"
     data-repartidor-id="<%= order.repartidor_id %>"
     data-order-lat="<%= order.latitud_entrega %>"
     data-order-lng="<%= order.longitud_entrega %>"
     style="display: none;"></div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="/js/order-tracking.js"></script>