<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'A la Mesa' %> - A la Mesa</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/cart.css" rel="stylesheet">
    <link href="/css/admin.css" rel="stylesheet">
    <link href="/css/dashboard-responsive.css" rel="stylesheet">
    <link href="/css/dashboard-stats-responsive.css" rel="stylesheet">
    <link href="/css/orders-history-responsive.css" rel="stylesheet">
    <link href="/css/orders-history-cards.css" rel="stylesheet">
    <link href="/css/cobros-cards.css" rel="stylesheet">
    <link href="/css/cookie-consent.css" rel="stylesheet">
    <link href="/css/dashboard-orders.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="icon" type="image/png" href="/images/logo-a-la-mesa.png">
    <%- typeof style !== 'undefined' ? style : '' %>
</head>
<body>
    <%- include('partials/header', { currentPath: currentPath, user: user }) %>

    <!-- Main Content -->
    <main class="container py-4">
        <%- body %>
    </main>

    <!-- Cart Container -->
    <div class="cart-container">
        <!-- Cart Overlay -->
        <div class="cart-overlay" id="cartOverlay"></div>
        <!-- Cart Sidebar (vacío, el JS lo llenará) -->
        <div class="cart-sidebar" id="cartSidebar"></div>
    </div>

    <!-- User Menu Container -->
    <div class="user-menu-container">
        <!-- User Menu Overlay -->
        <div class="user-menu-overlay" id="userMenuOverlay"></div>
        <!-- User Menu Sidebar -->
        <div class="user-menu-sidebar" id="userMenuSidebar"></div>
    </div>

    <!-- Toast Container Global -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

    <!-- Navegación móvil general o dashboard según usuario y ruta -->
    <% if (user && user.tipo_usuario && user.tipo_usuario === 'restaurante' && ((typeof isDashboardPage !== 'undefined' && isDashboardPage) || (currentPath && (currentPath.startsWith('/dashboard') || currentPath.startsWith('/dashboard/orders'))))) { %>
      <!-- Menú móvil dashboard restaurante -->
      <% const currentActivePage = typeof activePage !== 'undefined' ? activePage : ''; %>
      <nav class="mobile-nav mobile-only dashboard-mobile-nav d-md-none d-lg-none d-xl-none">
        <a href="/dashboard" class="mobile-nav-item <%= currentActivePage === 'dashboard' ? 'active' : '' %>">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="/dashboard/products" class="mobile-nav-item <%= currentActivePage === 'productos' ? 'active' : '' %>">
            <i class="fas fa-utensils"></i>
            <span>Productos</span>
        </a>
        <a href="/dashboard/orders" class="mobile-nav-item <%= currentActivePage === 'pedidos' ? 'active' : '' %>" style="position: relative;">
            <i class="fas fa-shopping-cart"></i>
            <span>Pedidos</span>
            <% if (typeof pedidos_no_entregados !== 'undefined' && pedidos_no_entregados > 0) { %>
                <span class="badge bg-danger rounded-pill" style="position: absolute; top: -7px; right: 3px; font-size: 1.17em; padding: 0.52em 0.78em;"><%= pedidos_no_entregados %></span>
            <% } %>
        </a>
        <a href="/dashboard/settings" class="mobile-nav-item <%= currentActivePage === 'configuracion' ? 'active' : '' %>">
            <i class="fas fa-cog"></i>
            <span>Config</span>
        </a>
        <a href="#" class="mobile-nav-item" id="dashboardMoreBtn">
            <i class="fas fa-ellipsis-h"></i>
            <span>Más</span>
        </a>
      </nav>

      <!-- Dashboard Mobile Overlay Menu -->
      <div class="dashboard-mobile-overlay-menu" id="dashboardMobileOverlayMenu">
        <div class="overlay-header">
          <button class="close-overlay-btn" id="closeDashboardOverlayBtn">&times;</button>
          <h5>Menú del Restaurante</h5>
        </div>
        <div class="overlay-content">
          <a href="/dashboard/estadisticas" class="overlay-nav-item <%= currentActivePage === 'estadisticas' ? 'active' : '' %>">
              <i class="fas fa-chart-bar"></i>
              <span>Estadísticas</span>
          </a>
          <a href="/dashboard/drivers" class="overlay-nav-item <%= currentActivePage === 'conductores' ? 'active' : '' %>">
              <i class="fas fa-motorcycle"></i>
              <span>Repartidores</span>
          </a>
          <a href="/dashboard/driver-requests" class="overlay-nav-item <%= currentActivePage === 'driver-requests' ? 'active' : '' %>">
              <i class="fas fa-user-plus"></i>
              <span>Solicitudes de Repartidores</span>
          </a>
          <a href="/dashboard/pagos" class="overlay-nav-item <%= currentActivePage === 'pagos' ? 'active' : '' %>">
              <i class="fas fa-money-bill-wave"></i>
              <span>Pagos y Cobros</span>
          </a>

          <a href="/auth/logout" class="overlay-nav-item">
              <i class="fas fa-sign-out-alt"></i>
              <span>Cerrar Sesión</span>
          </a>
        </div>
      </div>
    <% } else if (user && user.tipo_usuario && user.tipo_usuario === 'admin') { %>
      <!-- Menú móvil admin -->
      <%- include('partials/admin-mobile-nav', { currentPath: currentPath, user: user }) %>
    <% } else if (user && user.tipo_usuario && user.tipo_usuario === 'repartidor') { %>
      <!-- Menú móvil repartidor -->
      <%- include('drivers/mobile-nav', { currentPath: currentPath, user: user }) %>
    <% } else if (!(currentPath && currentPath.startsWith('/dashboard'))) { %>
      <!-- Menú móvil cliente -->
      <%- include('partials/client-mobile-nav', { currentPath: currentPath }) %>
    <% } %>

    <!-- Footer -->
    <footer class="bg-light py-4 mt-auto">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <h5 class="mb-3" style="color: #ff6b35;">
                        <i class="fas fa-utensils me-2"></i>
                        A la Mesa
                    </h5>
                    <p class="text-muted">
                        Tu plataforma de delivery de comida favorita. 
                        Conectamos los mejores restaurantes con nuestros clientes.
                    </p>
                    <div class="social-links">
                        <a href="#" class="text-muted me-3"><i class="fab fa-facebook fa-lg"></i></a>
                        <a href="#" class="text-muted me-3"><i class="fab fa-instagram fa-lg"></i></a>
                        <a href="mailto:alamesa.contacto@gmail.com" class="text-muted me-3"><i class="fas fa-envelope fa-lg"></i></a>
                        <!-- <a href="#" class="text-muted me-3"><i class="fab fa-twitter fa-lg"></i></a> -->
                        <!-- <a href="#" class="text-muted"><i class="fab fa-linkedin fa-lg"></i></a> -->
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <h6 class="text-dark mb-3">Enlaces Útiles</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="/about" class="text-muted text-decoration-none">
                                <i class="fas fa-info-circle me-2"></i>Sobre Nosotros
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/contact" class="text-muted text-decoration-none">
                                <i class="fas fa-envelope me-2"></i>Contacto
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/search" class="text-muted text-decoration-none">
                                <i class="fas fa-search me-2"></i>Buscar Restaurantes
                            </a>
                        </li>
                        <% if (typeof hideFooterBeneficios === 'undefined' || !hideFooterBeneficios) { %>
                        <li class="mb-2">
                            <a href="/beneficios-clientes" class="text-muted text-decoration-none">
                                <i class="fas fa-heart me-2"></i>Beneficios para Clientes
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/beneficios-restaurantes" class="text-muted text-decoration-none">
                                <i class="fas fa-building me-2"></i>Beneficios para Restaurantes
                            </a>
                        </li>
                        <% } %>
                        <li class="mb-2">
                            <a href="/bienvenido" class="text-muted text-decoration-none">
                                <i class="fas fa-hand-sparkles me-2"></i>Bienvenido
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="col-md-4 mb-3">
                    <h6 class="text-dark mb-3">Información Legal</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <a href="/terms" class="text-muted text-decoration-none">
                                <i class="fas fa-file-contract me-2"></i>Términos y Condiciones
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/privacy" class="text-muted text-decoration-none">
                                <i class="fas fa-user-shield me-2"></i>Política de Privacidad
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/legal-info" class="text-muted text-decoration-none">
                                <i class="fas fa-balance-scale me-2"></i>Información Legal
                            </a>
                        </li>
                        <li class="mb-2">
                            <a href="/restaurant-requirements" class="text-muted text-decoration-none">
                                <i class="fas fa-clipboard-check me-2"></i>Requisitos Restaurantes
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <hr class="my-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 text-muted">
                        &copy; 2025 A la Mesa. Todos los derechos reservados.
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0 text-muted">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        Colón, Bs As
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <%- include('partials/cookie-consent') %>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Socket.IO fallback loader -->
    <script src="/js/socket.io.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Custom JavaScript -->
    <script src="/js/app.js"></script>
    <script src="/js/cart.js"></script>
    <script src="/js/dashboard/products.js"></script>
    <script src="/js/cookie-consent.js"></script>

    <!-- GPS Tracker for Drivers -->
    <% if (user && user.tipo_usuario && user.tipo_usuario === 'repartidor') { %>
    <script src="/js/driver-gps-tracker.js"></script>
    <% } %>
    
    <!-- Bloque de datos de usuario para notificaciones push -->
    <% if (typeof user !== 'undefined' && user) { %>
      <script id="user-data-script" type="application/json">
        <%- JSON.stringify(user) %>
      </script>
    <% } %>
    <!-- Scripts principales -->
    <script src="/js/push-notifications.js"></script>
    
    <script>
    // Event listener para el carrito móvil global
    document.addEventListener('DOMContentLoaded', function() {
        
        
        // Los event listeners del carrito ahora se manejan centralmente en app.js
        // No es necesario asignarlos aquí para evitar duplicados
        
        // Event listener para el menú de usuario móvil

        
        // Event listener para cerrar el menú de usuario con overlay
        const userMenuOverlay = document.getElementById('userMenuOverlay');
        if (userMenuOverlay) {
            userMenuOverlay.addEventListener('click', function(e) {
                if (typeof window.closeUserMenu === 'function') {
                    window.closeUserMenu();
                }
            });
        }

        // Event listener para el enlace "Mi Perfil" en la navegación móvil
        const profileLink = document.querySelector('.client-mobile-nav-item[href="/auth/profile"]');
        if (profileLink) {
            profileLink.addEventListener('click', function(e) {
                e.preventDefault(); // Prevenir la navegación por defecto
                if (typeof window.toggleUserMenu === 'function') {
                    window.toggleUserMenu(e);
                }
            });
        }
        
        // Event listener para cerrar menús con Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (typeof window.closeCartSidebar === 'function') {
                    window.closeCartSidebar();
                }
                if (typeof window.closeUserMenu === 'function') {
                    window.closeUserMenu();
                }
            }
        });
        
        // Marcar como activo el item del menú correspondiente a la página actual
        const currentPath = window.location.pathname;
        const mobileNavItems = document.querySelectorAll('.mobile-nav .mobile-nav-item');
        mobileNavItems.forEach(item => {
            const href = item.getAttribute('href');
            if (href === currentPath || (currentPath === '/' && href === '/')) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });

        // Dashboard mobile overlay menu
        const dashboardMoreBtn = document.getElementById('dashboardMoreBtn');
        const dashboardMobileOverlayMenu = document.getElementById('dashboardMobileOverlayMenu');
        const closeDashboardOverlayBtn = document.getElementById('closeDashboardOverlayBtn');

        if (dashboardMoreBtn) {
            dashboardMoreBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (dashboardMobileOverlayMenu) {
                    dashboardMobileOverlayMenu.classList.add('show');
                    document.body.classList.add('overlay-open');
                }
            });
        }

        if (closeDashboardOverlayBtn) {
            closeDashboardOverlayBtn.addEventListener('click', function() {
                if (dashboardMobileOverlayMenu) {
                    dashboardMobileOverlayMenu.classList.remove('show');
                    document.body.classList.remove('overlay-open');
                }
            });
        }
    });
    </script>
    
    <%- script %>
</body>
</html>
