 <!-- CSS para vista móvil -->
<link href="/css/cobros-mobile.css" rel="stylesheet">

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-3 col-lg-2">
            <%- include('partials/sidebar', { activePage: 'cobros' }) %>
        </div>
        <div class="col-md-9 col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">Gestión de Cobros</h1>
                <div class="d-flex gap-2">
                    <button id="btnGenerarCobros" class="btn btn-warning">
                        <i class="fas fa-magic me-2"></i>Generar Cobros Semanales
                    </button>
                    <button id="btnCobrarRestaurante" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalCobrarRestaurante">
                        <i class="fas fa-store me-2"></i>Cobrar Restaurante Específico
                    </button>
                    <a href="/admin/pagos-semanales" class="btn btn-outline-primary">
                        <i class="fas fa-calendar-week me-2"></i>Ver Tabla Semanal
                    </a>
                    <a href="/admin/cobros/export" class="btn btn-success">
                        <i class="fas fa-download me-2"></i>Exportar
                    </a>
                </div>
            </div>

            <!-- Resumen de Cobros -->
            <div class="row mb-4 resumen-mobile">
                <div class="col-md-4 col-12">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Pendiente</h5>
                            <p class="card-text fs-4">$<%= Number(resumen.total_pendiente || 0).toFixed(2) %></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-12">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Pagado</h5>
                            <p class="card-text fs-4">$<%= Number(resumen.total_pagado || 0).toFixed(2) %></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-12">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total de Comisiones</h5>
                            <p class="card-text fs-4">$<%= Number(resumen.total_comisiones || 0).toFixed(2) %></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <form action="/admin/cobros" method="GET">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="restaurante" class="form-label">Restaurante</label>
                                <input type="text" class="form-control" id="restaurante" name="restaurante" value="<%= filtros.restaurante %>">
                            </div>
                            <div class="col-md-3">
                                <label for="estado" class="form-label">Estado</label>
                                <select class="form-select" id="estado" name="estado">
                                    <option value="" <%= filtros.estado === '' ? 'selected' : '' %>>Todos</option>
                                    <option value="pendiente" <%= filtros.estado === 'pendiente' ? 'selected' : '' %>>Pendiente</option>
                                    <option value="pagado" <%= filtros.estado === 'pagado' ? 'selected' : '' %>>Pagado</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="semana" class="form-label">Semana</label>
                                <select class="form-select" id="semana" name="semana">
                                    <option value="">Todas las semanas</option>
                                    <% for (let i = 0; i < 52; i++) { %>
                                        <% const weekNumber = i + 1; %>
                                        <% const year = new Date().getFullYear(); %>
                                        <% const weekValue = `${year}-W${weekNumber.toString().padStart(2, '0')}`; %>
                                        <option value="<%= weekValue %>" <%= filtros.semana === weekValue ? 'selected' : '' %>>
                                            Semana <%= weekNumber %> (<%= year %>)
                                        </option>
                                    <% } %>
                                </select>
                                <div class="form-text">Selecciona una semana específica para filtrar cobros</div>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button class="btn btn-primary w-100">Filtrar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tabla de Cobros (Desktop) -->
            <div class="card cobros-desktop-cards">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Restaurante</th>
                                    <th>Semana</th>
                                    <th>Monto Comisión</th>
                                    <th>Monto Pagado</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% cobros.forEach(cobro => { %>
                                    <tr>
                                        <td><%= cobro.id %></td>
                                        <td><%= cobro.restaurante_nombre %></td>
                                        <td><%= new Date(cobro.semana_inicio).toLocaleDateString() %> - <%= new Date(cobro.semana_fin).toLocaleDateString() %></td>
                                        <td>$<%= Number(cobro.monto_comision || 0).toFixed(2) %></td>
                                        <td>$<%= Number(cobro.monto_pagado || 0).toFixed(2) %></td>
                                        <td>
                                            <span class="badge bg-<%= cobro.estado === 'pagado' ? 'success' : 'warning' %>">
                                                <%= cobro.estado %>
                                            </span>
                                        </td>
                                        <td>
                                            <a href="/admin/cobros/<%= cobro.id %>" class="btn btn-sm btn-info me-1">Ver Detalles</a>
                                            <button class="btn btn-sm btn-danger" onclick="eliminarCobro(<%= cobro.id %>)">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tarjetas de Cobros (Móvil) -->
            <div class="cobros-mobile-cards">
                <% cobros.forEach(cobro => { %>
                    <div class="cobro-card">
                        <div class="cobro-card-header">
                            <div class="cobro-card-id">Cobro #<%= cobro.id %></div>
                            <div class="cobro-card-restaurante"><%= cobro.restaurante_nombre %></div>
                            <div class="cobro-card-semana">
                                <%= new Date(cobro.semana_inicio).toLocaleDateString() %> - <%= new Date(cobro.semana_fin).toLocaleDateString() %>
                            </div>
                        </div>
                        <div class="cobro-card-body">
                            <div class="cobro-info-row">
                                <span class="cobro-info-label">Comisión:</span>
                                <span class="cobro-info-value amount">$<%= Number(cobro.monto_comision || 0).toFixed(2) %></span>
                            </div>
                            <div class="cobro-info-row">
                                <span class="cobro-info-label">Pagado:</span>
                                <span class="cobro-info-value amount <%= cobro.estado === 'pagado' ? '' : 'pending' %>">
                                    $<%= Number(cobro.monto_pagado || 0).toFixed(2) %>
                                </span>
                            </div>
                            <div class="cobro-info-row">
                                <span class="cobro-info-label">Estado:</span>
                                <span class="estado-badge estado-<%= cobro.estado %>">
                                    <%= cobro.estado %>
                                </span>
                            </div>
                        </div>
                        <div class="cobro-card-footer">
                            <a href="/admin/cobros/<%= cobro.id %>" class="btn btn-ver-detalles me-2">
                                <i class="fas fa-eye me-2"></i>Ver Detalles
                            </a>
                            <button class="btn btn-eliminar" onclick="eliminarCobro(<%= cobro.id %>)">
                                <i class="fas fa-trash me-2"></i>Eliminar
                            </button>
                        </div>
                    </div>
                <% }); %>
            </div>

        </div>
    </div>
</div>

<!-- Modal de Confirmación para Generar Cobros -->
<div class="modal fade" id="modalGenerarCobros" tabindex="-1" aria-labelledby="modalGenerarCobrosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalGenerarCobrosLabel">
                    <i class="fas fa-magic me-2"></i>Generar Cobros Semanales Automáticamente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>¿Qué hace esta función?</h6>
                    <ul class="mb-0">
                        <li>Genera cobros semanales para <strong>TODOS</strong> los restaurantes activos y verificados</li>
                        <li>Calcula comisiones del <strong>10%</strong> sobre ventas brutas</li>
                        <li>Considera pedidos en estados: <strong>entregado, en_camino, listo, pendiente, confirmado, preparando</strong></li>
                        <li>Establece fecha de vencimiento en <strong>7 días</strong></li>
                        <li>Envía emails automáticos a cada restaurante</li>
                        <li><strong>Nota:</strong> Solo se generan cobros para restaurantes que tengan pedidos en el período seleccionado</li>
                    </ul>
                </div>

                <form id="formGenerarCobrosAutomatico">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>Seleccionar Período</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="semanaAutomatico" class="form-label">Seleccionar Semana *</label>
                                        <select class="form-select" id="semanaAutomatico" name="semana" required>
                                            <option value="">Selecciona una semana...</option>
                                            <% for (let i = 0; i < 52; i++) { %>
                                                <% const weekNumber = i + 1; %>
                                                <% const year = new Date().getFullYear(); %>
                                                <% const weekValue = `${year}-W${weekNumber.toString().padStart(2, '0')}`; %>
                                                <option value="<%= weekValue %>">
                                                    Semana <%= weekNumber %> (<%= year %>)
                                                </option>
                                            <% } %>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="fechaInicioAutomatico" class="form-label">Fecha Inicio *</label>
                                        <input type="date" class="form-control" id="fechaInicioAutomatico" name="fecha_inicio" required readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="fechaFinAutomatico" class="form-label">Fecha Fin *</label>
                                        <input type="date" class="form-control" id="fechaFinAutomatico" name="fecha_fin" required readonly>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="btnUsarSemanaActual">
                                        <i class="fas fa-calendar-week me-1"></i>Usar Semana Actual
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-store me-2"></i>Restaurantes a Procesar</h6>
                                </div>
                                <div class="card-body">
                                    <div id="infoRestaurantes">
                                        <p class="mb-1"><strong>Total:</strong> <span id="totalRestaurantes">Todos los activos</span> restaurantes</p>
                                        <p class="mb-0"><strong>Estado:</strong> <span class="badge bg-success">Activos y Verificados</span></p>
                                        <p class="mb-0"><strong>Criterio:</strong> Solo restaurantes con pedidos en el período</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Importante</h6>
                    <p class="mb-0">
                        Esta acción <strong>NO se puede deshacer</strong>. Los cobros generados se crearán en la base de datos 
                        y se enviarán emails a todos los restaurantes. Asegúrate de que sea el momento correcto para generar los cobros.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btnConfirmarGenerar">
                    <i class="fas fa-magic me-2"></i>Generar Cobros Ahora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Progreso -->
<div class="modal fade" id="modalProgreso" tabindex="-1" aria-labelledby="modalProgresoLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalProgresoLabel">
                    <i class="fas fa-cog fa-spin me-2"></i>Generando Cobros...
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Generando...</span>
                    </div>
                </div>
                <p class="mb-2">Generando cobros semanales para todos los restaurantes...</p>
                <p class="text-muted small">Esto puede tomar unos minutos. Por favor, no cierres esta ventana.</p>

                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Cobrar Restaurante Específico -->
<div class="modal fade" id="modalCobrarRestaurante" tabindex="-1" aria-labelledby="modalCobrarRestauranteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalCobrarRestauranteLabel">
                    <i class="fas fa-store me-2"></i>Cobrar Restaurante Específico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formCobrarRestaurante">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>¿Qué hace esta función?</h6>
                        <ul class="mb-0">
                            <li>Genera cobros semanales para <strong>un restaurante específico</strong></li>
                            <li>Calcula comisiones del <strong>10%</strong> sobre ventas brutas</li>
                            <li>Considera pedidos en estados: <strong>entregado, en_camino, listo, pendiente, confirmado, preparando</strong></li>
                            <li>Establece fecha de vencimiento en <strong>7 días</strong></li>
                            <li>Envía email automático al restaurante seleccionado</li>
                            <li><strong>Nota:</strong> Solo se genera cobro si el restaurante tiene pedidos en la semana</li>
                        </ul>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="restauranteSeleccionado" class="form-label">Seleccionar Restaurante *</label>
                                <select class="form-select" id="restauranteSeleccionado" name="restaurante_id" required>
                                    <option value="">Selecciona un restaurante...</option>
                                    <% if (typeof restaurantes !== 'undefined' && restaurantes && restaurantes.length > 0) { %>
                                        <% restaurantes.forEach(function(rest) { %>
                                            <option value="<%= rest.id %>"><%= rest.nombre %></option>
                                        <% }); %>
                                    <% } %>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fechaInicioEspecifica" class="form-label">Fecha Inicio *</label>
                                <input type="date" class="form-control" id="fechaInicioEspecifica" name="fecha_inicio" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fechaFinEspecifica" class="form-label">Fecha Fin *</label>
                                <input type="date" class="form-control" id="fechaFinEspecifica" name="fecha_fin" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>Período Seleccionado</h6>
                                </div>
                                <div class="card-body">
                                    <div id="periodoSeleccionado">
                                        <p class="mb-1"><strong>Desde:</strong> <span id="fechaInicioDisplay">-</span></p>
                                        <p class="mb-0"><strong>Hasta:</strong> <span id="fechaFinDisplay">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Importante</h6>
                        <p class="mb-0">
                            Esta acción <strong>NO se puede deshacer</strong>. El cobro generado se creará en la base de datos
                            y se enviará un email al restaurante. Asegúrate de que las fechas y el restaurante sean correctos.
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-info" id="btnConfirmarCobrarRestaurante">
                        <i class="fas fa-store me-2"></i>Generar Cobro
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- SweetAlert2 para notificaciones -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- JavaScript para Generar Cobros -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btnGenerarCobros = document.getElementById('btnGenerarCobros');
    const btnConfirmarGenerar = document.getElementById('btnConfirmarGenerar');
    const modalGenerarCobros = new bootstrap.Modal(document.getElementById('modalGenerarCobros'));
    const modalProgreso = new bootstrap.Modal(document.getElementById('modalProgreso'));

    // Calcular fechas de la semana actual
    function calcularPeriodoSemana() {
        const hoy = new Date();
        const lunes = new Date(hoy);
        const diff = hoy.getDay() === 0 ? 6 : hoy.getDay() - 1;
        lunes.setDate(hoy.getDate() - diff);
        lunes.setHours(0, 0, 0, 0);
        
        const domingo = new Date(lunes);
        domingo.setDate(lunes.getDate() + 6);
        domingo.setHours(23, 59, 59, 999);

        return {
            inicio: lunes.toLocaleDateString('es-AR'),
            fin: domingo.toLocaleDateString('es-AR')
        };
    }

    // Función para obtener fechas de una semana específica
    function getWeekDates(weekValue) {
        if (!weekValue) return null;

        const [year, week] = weekValue.split('-W');
        const weekNum = parseInt(week);

        // Crear fecha del primer día de la semana (lunes)
        const firstDayOfYear = new Date(year, 0, 1);
        const daysToFirstMonday = (8 - firstDayOfYear.getDay()) % 7;
        const firstMonday = new Date(year, 0, 1 + daysToFirstMonday);

        // Calcular el lunes de la semana seleccionada
        const monday = new Date(firstMonday);
        monday.setDate(firstMonday.getDate() + (weekNum - 1) * 7);

        // Calcular el domingo de la semana
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);

        return {
            inicio: monday.toISOString().split('T')[0],
            fin: sunday.toISOString().split('T')[0]
        };
    }

    // Función para actualizar fechas cuando cambia la semana
    function updateDatesFromWeek(selectId, startDateId, endDateId) {
        const select = document.getElementById(selectId);
        const startInput = document.getElementById(startDateId);
        const endInput = document.getElementById(endDateId);

        select.addEventListener('change', function() {
            const selectedValue = this.value;
            if (selectedValue) {
                const dates = getWeekDates(selectedValue);
                if (dates) {
                    startInput.value = dates.inicio;
                    endInput.value = dates.fin;
                }
            } else {
                startInput.value = '';
                endInput.value = '';
            }
        });
    }

    // Mostrar modal de confirmación
    btnGenerarCobros.addEventListener('click', function() {
        // Establecer semana actual por defecto
        const semanaSelect = document.getElementById('semanaAutomatico');
        const fechaInicioInput = document.getElementById('fechaInicioAutomatico');
        const fechaFinInput = document.getElementById('fechaFinAutomatico');

        // Calcular semana actual
        const hoy = new Date();
        const year = hoy.getFullYear();
        const firstDayOfYear = new Date(year, 0, 1);
        const daysToFirstMonday = (8 - firstDayOfYear.getDay()) % 7;
        const firstMonday = new Date(year, 0, 1 + daysToFirstMonday);
        const weekNumber = Math.ceil(((hoy - firstMonday) / 86400000) / 7) + 1;
        const currentWeekValue = `${year}-W${weekNumber.toString().padStart(2, '0')}`;

        semanaSelect.value = currentWeekValue;

        // Actualizar fechas automáticamente
        const dates = getWeekDates(currentWeekValue);
        if (dates) {
            fechaInicioInput.value = dates.inicio;
            fechaFinInput.value = dates.fin;
        }

        // Mostrar información estática
        document.getElementById('totalRestaurantes').textContent = 'Todos los activos';

        modalGenerarCobros.show();
    });

    // Configurar actualización automática de fechas para el selector de semana
    updateDatesFromWeek('semanaAutomatico', 'fechaInicioAutomatico', 'fechaFinAutomatico');

    // Botón para usar semana actual
    document.getElementById('btnUsarSemanaActual').addEventListener('click', function() {
        const semanaSelect = document.getElementById('semanaAutomatico');
        const fechaInicioInput = document.getElementById('fechaInicioAutomatico');
        const fechaFinInput = document.getElementById('fechaFinAutomatico');

        // Calcular semana actual
        const hoy = new Date();
        const year = hoy.getFullYear();
        const firstDayOfYear = new Date(year, 0, 1);
        const daysToFirstMonday = (8 - firstDayOfYear.getDay()) % 7;
        const firstMonday = new Date(year, 0, 1 + daysToFirstMonday);
        const weekNumber = Math.ceil(((hoy - firstMonday) / 86400000) / 7) + 1;
        const currentWeekValue = `${year}-W${weekNumber.toString().padStart(2, '0')}`;

        // Seleccionar la semana actual en el selector
        semanaSelect.value = currentWeekValue;

        // Actualizar fechas automáticamente
        const dates = getWeekDates(currentWeekValue);
        if (dates) {
            fechaInicioInput.value = dates.inicio;
            fechaFinInput.value = dates.fin;
        }
    });

    // Confirmar generación de cobros
    btnConfirmarGenerar.addEventListener('click', function() {
        // Obtener las fechas del formulario
        const form = document.getElementById('formGenerarCobrosAutomatico');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Validar que las fechas sean válidas
        if (!data.fecha_inicio || !data.fecha_fin) {
            Swal.fire({
                icon: 'error',
                title: 'Fechas Requeridas',
                text: 'Debes seleccionar tanto la fecha de inicio como la fecha de fin.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc3545'
            });
            return;
        }

        if (new Date(data.fecha_inicio) >= new Date(data.fecha_fin)) {
            Swal.fire({
                icon: 'error',
                title: 'Fechas Inválidas',
                text: 'La fecha de inicio debe ser anterior a la fecha de fin.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc3545'
            });
            return;
        }

        modalGenerarCobros.hide();
        modalProgreso.show();

        // Deshabilitar botón durante el proceso
        btnConfirmarGenerar.disabled = true;
        btnConfirmarGenerar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';

        // Llamar a la API para generar cobros con las fechas seleccionadas
        fetch('/admin/cobros/generar-automatico', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            modalProgreso.hide();

            if (data.success) {
                // Mostrar mensaje de éxito
                Swal.fire({
                    icon: 'success',
                    title: '¡Cobros Generados Exitosamente!',
                    html: `
                        <div class="text-start">
                            <p><strong>Período:</strong> ${data.data.fecha_inicio} al ${data.data.fecha_fin}</p>
                            <p><strong>Cobros generados:</strong> ${data.data.cobrosGenerados} restaurantes</p>
                            <p><strong>Total comisiones:</strong> $${data.data.totalComisiones.toLocaleString()}</p>
                            <p><strong>Restaurantes procesados:</strong> ${data.data.restaurantes}</p>
                        </div>
                    `,
                    confirmButtonText: 'Perfecto',
                    confirmButtonColor: '#28a745'
                }).then(() => {
                    // Recargar la página para mostrar los nuevos cobros
                    window.location.reload();
                });
            } else {
                // Mostrar mensaje de error
                Swal.fire({
                    icon: 'error',
                    title: 'Error al Generar Cobros',
                    text: data.message,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545'
                });
            }
        })
        .catch(error => {
            modalProgreso.hide();
            console.error('Error:', error);

            Swal.fire({
                icon: 'error',
                title: 'Error de Conexión',
                text: 'Hubo un problema al conectar con el servidor. Por favor, intenta nuevamente.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc3545'
            });
        })
        .finally(() => {
            // Restaurar botón
            btnConfirmarGenerar.disabled = false;
            btnConfirmarGenerar.innerHTML = '<i class="fas fa-magic me-2"></i>Generar Cobros Ahora';
        });
    });
});

// JavaScript para Cobrar Restaurante Específico
document.addEventListener('DOMContentLoaded', function() {
    const formCobrarRestaurante = document.getElementById('formCobrarRestaurante');
    const btnConfirmarCobrarRestaurante = document.getElementById('btnConfirmarCobrarRestaurante');
    const modalCobrarRestaurante = new bootstrap.Modal(document.getElementById('modalCobrarRestaurante'));
    const fechaInicioInput = document.getElementById('fechaInicioEspecifica');
    const fechaFinInput = document.getElementById('fechaFinEspecifica');
    const fechaInicioDisplay = document.getElementById('fechaInicioDisplay');
    const fechaFinDisplay = document.getElementById('fechaFinDisplay');

    // Actualizar display de fechas cuando cambian
    function actualizarDisplayFechas() {
        const fechaInicio = fechaInicioInput.value;
        const fechaFin = fechaFinInput.value;

        if (fechaInicio) {
            const fecha = new Date(fechaInicio);
            fechaInicioDisplay.textContent = fecha.toLocaleDateString('es-AR');
        } else {
            fechaInicioDisplay.textContent = '-';
        }

        if (fechaFin) {
            const fecha = new Date(fechaFin);
            fechaFinDisplay.textContent = fecha.toLocaleDateString('es-AR');
        } else {
            fechaFinDisplay.textContent = '-';
        }
    }

    fechaInicioInput.addEventListener('change', actualizarDisplayFechas);
    fechaFinInput.addEventListener('change', actualizarDisplayFechas);

    // Manejar envío del formulario
    formCobrarRestaurante.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(formCobrarRestaurante);
        const data = Object.fromEntries(formData.entries());

        // Validar que las fechas sean válidas
        if (new Date(data.fecha_inicio) >= new Date(data.fecha_fin)) {
            Swal.fire({
                icon: 'error',
                title: 'Fechas Inválidas',
                text: 'La fecha de inicio debe ser anterior a la fecha de fin.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc3545'
            });
            return;
        }

        // Deshabilitar botón durante el proceso
        btnConfirmarCobrarRestaurante.disabled = true;
        btnConfirmarCobrarRestaurante.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generando...';

        // Llamar a la API para generar cobro específico
        fetch('/admin/cobros/generar-especifico', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            modalCobrarRestaurante.hide();

            if (data.success) {
                // Mostrar mensaje de éxito
                Swal.fire({
                    icon: 'success',
                    title: '¡Cobro Generado Exitosamente!',
                    html: `
                        <div class="text-start">
                            <p><strong>Restaurante:</strong> ${data.data.restaurante_nombre}</p>
                            <p><strong>Período:</strong> ${data.data.fecha_inicio} al ${data.data.fecha_fin}</p>
                            <p><strong>Ventas brutas:</strong> $${data.data.ventas_brutas.toLocaleString()}</p>
                            <p><strong>Comisión (10%):</strong> $${data.data.monto_comision.toLocaleString()}</p>
                            <p><strong>Vencimiento:</strong> ${data.data.fecha_vencimiento}</p>
                        </div>
                    `,
                    confirmButtonText: 'Perfecto',
                    confirmButtonColor: '#28a745'
                }).then(() => {
                    // Recargar la página para mostrar el nuevo cobro
                    window.location.reload();
                });
            } else {
                // Mostrar mensaje de error
                Swal.fire({
                    icon: 'error',
                    title: 'Error al Generar Cobro',
                    text: data.message,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalCobrarRestaurante.hide();

            Swal.fire({
                icon: 'error',
                title: 'Error de Conexión',
                text: 'Hubo un problema al conectar con el servidor. Por favor, intenta nuevamente.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#dc3545'
            });
        })
        .finally(() => {
            // Restaurar botón
            btnConfirmarCobrarRestaurante.disabled = false;
            btnConfirmarCobrarRestaurante.innerHTML = '<i class="fas fa-store me-2"></i>Generar Cobro';
        });
    });
});

// Función para eliminar cobro
function eliminarCobro(cobroId) {
    Swal.fire({
        title: '¿Estás seguro?',
        text: 'Esta acción eliminará permanentemente el cobro de comisión. Esta acción no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Mostrar loading
            Swal.fire({
                title: 'Eliminando...',
                text: 'Por favor espera mientras se elimina el cobro.',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            // Hacer la petición DELETE
            fetch(`/admin/cobros/${cobroId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Cobro Eliminado!',
                        text: 'El cobro de comisión ha sido eliminado exitosamente.',
                        confirmButtonText: 'Perfecto',
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        // Recargar la página para actualizar la lista
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al Eliminar',
                        text: data.message || 'Hubo un problema al eliminar el cobro.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error de Conexión',
                    text: 'Hubo un problema al conectar con el servidor. Por favor, intenta nuevamente.',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#dc3545'
                });
            });
        }
    });
}
</script>
