<div class="admin-layout">
    <div class="d-flex">
        <!-- Sidebar -->
        <%- include('partials/sidebar', { activePage: 'pagos-semanales' }) %>
        
        <!-- Main Content -->
        <div class="flex-grow-1 d-flex flex-column" style="min-height: 100vh;">
            <!-- Top Bar -->
            <div class="admin-topbar bg-white shadow-sm px-4 py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-week me-2"></i>
                        Tabla Semanal de Pagos
                    </h5>
                    <small class="text-muted">Resumen anual de pagos y comisiones</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="me-3">
                        <i class="fas fa-user-shield me-1"></i>
                        <%= user.nombre %> <%= user.apellido %>
                    </span>
                    <a href="/auth/logout" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-sign-out-alt me-1"></i> Cerrar Sesión
                    </a>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="flex-grow-1 p-4">
                <!-- Filtros -->
                <div class="mb-4">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label for="year" class="form-label">Año</label>
                            <select name="year" id="year" class="form-select" onchange="this.form.submit()">
                                <% for(let y = 2023; y <= new Date().getFullYear() + 1; y++) { %>
                                    <option value="<%= y %>" <%= y == year ? 'selected' : '' %>><%= y %></option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="restaurante" class="form-label">Restaurante</label>
                            <select name="restaurante" id="restaurante" class="form-select" onchange="this.form.submit()">
                                <option value="">Todos los restaurantes</option>
                                <% if (typeof restaurantes !== 'undefined' && restaurantes) { %>
                                    <% restaurantes.forEach(function(rest) { %>
                                        <option value="<%= rest.id %>" <%= (typeof restaurante !== 'undefined' && restaurante == rest.id) ? 'selected' : '' %>><%= rest.nombre %></option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <a href="/admin/pagos-semanales/export?year=<%= year %>" class="btn btn-success">
                                <i class="fas fa-download me-2"></i>Exportar Excel
                            </a>
                        </div>
                    </form>
                </div>
                
                <!-- Resumen de estadísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total Comisiones</h6>
                                <h3 class="mb-0">$<%= resumen.total_comisiones.toLocaleString('es-AR') %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total Pagado</h6>
                                <h3 class="mb-0 text-success">$<%= resumen.total_pagado.toLocaleString('es-AR') %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total Pendiente</h6>
                                <h3 class="mb-0 text-warning">$<%= resumen.total_pendiente.toLocaleString('es-AR') %></h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">Total Exonerado</h6>
                                <h3 class="mb-0 text-info">$<%= resumen.total_exonerado.toLocaleString('es-AR') %></h3>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Comisiones por Semana
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px;">
                                    <canvas id="chartComisiones"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-pie me-2"></i>Distribución de Pagos
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container d-flex justify-content-center" style="position: relative; height: 250px;">
                                    <canvas id="chartEstados"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de pagos por restaurante y semana -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-table me-2"></i>Estado de Pagos por Restaurante y Semana
                        </h6>
                        <div class="d-flex gap-2">
                            <a href="/admin/cobros" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Volver a Cobros
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 700px; overflow-y: auto; overflow-x: auto;">
                            <table class="table table-hover table-bordered mb-0 table-sticky-header" style="min-width: 1200px;">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-nowrap sticky-column">Restaurante</th>
                                        <% semanasAnio.forEach(semana => { %>
                                            <th class="text-center text-nowrap" title="Semana <%= semana.numero %>: <%= new Date(semana.inicio).toLocaleDateString('es-AR') %> - <%= new Date(semana.fin).toLocaleDateString('es-AR') %>">
                                                S<%= semana.numero %>
                                            </th>
                                        <% }); %>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (pagosPorRestaurantePorSemana.length === 0) { %>
                                        <tr>
                                            <td colspan="<%= semanasAnio.length + 1 %>" class="text-center py-4">
                                                <div class="text-muted">No hay datos de pagos disponibles para el año y filtros seleccionados.</div>
                                            </td>
                                        </tr>
                                    <% } else { %>
                                        <% pagosPorRestaurantePorSemana.forEach(restauranteData => { %>
                                            <tr>
                                                <td class="text-nowrap sticky-column">
                                                    <%= restauranteData.nombre %>
                                                </td>
                                                <% restauranteData.semanas.forEach(semana => { %>
                                                    <td class="text-center">
                                                        <% if (semana.estado_pago === 'pagado') { %>
                                                            <i class="fas fa-check-circle text-success" title="Pagado: $<%= semana.monto_pagado_aprobado.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>"></i>
                                                        <% } else if (semana.estado_pago === 'pendiente') { %>
                                                            <a href="/admin/cobros/<%= semana.cobro_id %>" class="text-warning" title="Pendiente: $<%= semana.monto_comision.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>">
                                                                <i class="fas fa-circle"></i>
                                                            </a>
                                                        <% } else if (semana.estado_pago === 'vencido') { %>
                                                            <a href="/admin/cobros/<%= semana.cobro_id %>" class="text-danger" title="Vencido: $<%= semana.monto_comision.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>">
                                                                <i class="fas fa-times-circle"></i>
                                                            </a>
                                                        <% } else if (semana.estado_pago === 'exonerado') { %>
                                                            <i class="fas fa-minus-circle text-info" title="Exonerado: $<%= semana.monto_comision.toLocaleString('es-AR', {minimumFractionDigits: 2}) %>"></i>
                                                        <% } else { %>
                                                            <i class="fas fa-minus text-muted" title="Sin datos de cobro"></i>
                                                        <% } %>
                                                    </td>
                                                <% }); %>
                                            </tr>
                                        <% }); %>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Inicializar variables globales para el gráfico
window.datosGrafico = [];
window.currentYear = 0;

// Verificar y asignar los datos del gráfico
if (typeof datosGrafico !== 'undefined') {
    window.datosGrafico = typeof datosGrafico === 'string' ? JSON.parse(datosGrafico) : datosGrafico;
}
if (typeof year !== 'undefined') {
    window.currentYear = year;
}

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips de Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Usar los datos globales del gráfico
    const semanas = window.datosGrafico || [];

    // Gráfico de comisiones por semana
    const ctxComisiones = document.getElementById('chartComisiones');
    if (ctxComisiones) {
        new Chart(ctxComisiones, {
            type: 'line',
            data: {
                labels: semanas.map(s => `Semana ${s.semana}`),
                datasets: [{
                    label: 'Comisión Total',
                    data: semanas.map(s => s.comision),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    fill: true
                }, {
                    label: 'Pagado',
                    data: semanas.map(s => s.pagado),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString('es-AR');
                            }
                        },
                        grid: {
                            drawBorder: false
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += '$' + context.parsed.y.toLocaleString('es-AR', {minimumFractionDigits: 2});
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }

    // Gráfico de distribución por estado
    const ctxEstados = document.getElementById('chartEstados');
    if (ctxEstados) {
        const totalPagado = <%- resumen ? JSON.stringify(resumen.total_pagado || 0) : '0' %>;
        const totalPendiente = <%- resumen ? JSON.stringify(resumen.total_pendiente || 0) : '0' %>;
        const totalExonerado = <%- resumen ? JSON.stringify(resumen.total_exonerado || 0) : '0' %>;
        
        new Chart(ctxEstados, {
            type: 'doughnut',
            data: {
                labels: ['Pagado', 'Pendiente', 'Exonerado'],
                datasets: [{
                    data: [totalPagado, totalPendiente, totalExonerado],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(54, 162, 235, 0.8)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: $${value.toLocaleString('es-AR', {minimumFractionDigits: 2})} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

<!-- Script para manejar la actualización de filtros -->
<script>
// Actualizar la URL cuando cambian los filtros
function updateFilter() {
    const year = document.getElementById('year').value;
    const restaurante = document.getElementById('restaurante').value;
    
    let url = `/admin/pagos-semanales?year=${year}`;
    if (restaurante) {
        url += `&restaurante=${restaurante}`;
    }
    
    window.location.href = url;
}

// Asignar eventos a los filtros
document.addEventListener('DOMContentLoaded', function() {
    const yearSelect = document.getElementById('year');
    const restauranteSelect = document.getElementById('restaurante');
    
    if (yearSelect) {
        yearSelect.addEventListener('change', updateFilter);
    }
    
    if (restauranteSelect) {
        restauranteSelect.addEventListener('change', updateFilter);
    }
});
</script>

<!-- Incluir navegación móvil -->
<%- include('../partials/admin-mobile-nav', { user: user, currentPath: '/admin/pagos-semanales' }) %>

<!-- Scripts adicionales -->
<script>
// Inicializar tooltips de Bootstrap
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
});

// Función para confirmar acciones
function confirmAction(message, callback) {
    if (confirm(message)) {
        if (typeof callback === 'function') {
            callback();
        }
    }
    return false;
}
</script>
