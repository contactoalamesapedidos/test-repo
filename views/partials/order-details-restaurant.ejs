<!-- Order Info -->
<div class="order-info mb-4">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h5 class="mb-1">Pedido #<%= order.numero_pedido %></h5>
            <p class="text-muted mb-0">
                <i class="fas fa-clock me-1"></i>
                <%= new Date(order.fecha_pedido).toLocaleString('es-AR') %>
            </p>
        </div>
        <span class="badge bg-<%= order.estado === 'pendiente' ? 'warning' :
                              order.estado === 'confirmado' ? 'info' :
                              order.estado === 'en_preparacion' ? 'primary' :
                              order.estado === 'en_camino' ? 'secondary' :
                              order.estado === 'entregado' ? 'success' :
                              order.estado === 'cancelado' ? 'danger' : 'secondary' %>">
            <%= order.estado.charAt(0).toUpperCase() + order.estado.slice(1).replace('_', ' ') %>
        </span>
    </div>
</div>

<!-- Customer Info -->
<div class="customer-info mb-4">
    <h6 class="mb-3">Información del Cliente</h6>
    <div class="p-3 bg-light rounded">
        <p class="mb-2">
            <i class="fas fa-user text-primary me-2"></i>
            <strong>Cliente:</strong> <%= order.cliente_nombre %> <%= order.cliente_apellido %>
        </p>
        <p class="mb-2">
            <i class="fas fa-phone text-primary me-2"></i>
            <strong>Teléfono:</strong> <%= order.cliente_telefono %>
        </p>
        <p class="mb-0">
            <i class="fas fa-envelope text-primary me-2"></i>
            <strong>Email:</strong> <%= order.cliente_email %>
        </p>
    </div>
</div>

<!-- Order Items -->
<div class="order-items mb-4">
    <h6 class="mb-3">Productos</h6>
    <% if (items && items.length > 0) { %>
        <% items.forEach(item => { %>
            <div class="order-item d-flex align-items-center mb-3 p-3 border rounded">
                <img src="<%= item.imagen || '/images/no-image.png' %>" 
                     alt="<%= item.nombre || 'Producto' %>" 
                     class="rounded me-3" width="80" height="80"
                     style="object-fit: cover;">
                <div class="flex-grow-1">
                    <h6 class="mb-1"><%= item.nombre || 'Producto sin nombre' %></h6>
                    <% if (item.notas_especiales) { %>
                        <small class="text-muted d-block mb-1">
                            <i class="fas fa-comment-alt me-1"></i>
                            <%= item.notas_especiales %>
                        </small>
                    <% } %>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Cantidad: <%= item.cantidad || 0 %></span>
                        <strong>$<%= (Number(item.precio_unitario || 0) * Number(item.cantidad || 0)).toFixed(2) %></strong>
                    </div>
                </div>
            </div>
        <% }) %>
    <% } else { %>
        <div class="alert alert-info">
            No hay productos en este pedido
        </div>
    <% } %>
</div>

<!-- Order Summary -->
<div class="order-summary p-3 bg-light rounded mb-4">
    <h6 class="mb-3">Resumen del Pedido</h6>
    <div class="d-flex justify-content-between mb-2">
        <span>Subtotal:</span>
        <strong>$<%= Number(order.subtotal || 0).toFixed(2) %></strong>
    </div>
    <div class="d-flex justify-content-between mb-2">
        <span>Envío:</span>
        <strong>$<%= Number(order.costo_delivery || 0).toFixed(2) %></strong>
    </div>
    <hr>
    <div class="d-flex justify-content-between mb-2">
        <span class="fs-5">Total:</span>
        <strong class="fs-5 text-primary">$<%= Number(order.total || 0).toFixed(2) %></strong>
    </div>
</div>

<!-- Delivery Info -->
<div class="delivery-info mb-4">
    <h6 class="mb-3">Información de Entrega</h6>
    <div class="p-3 bg-light rounded">
        <p class="mb-2">
            <i class="fas fa-map-marker-alt text-primary me-2"></i>
            <strong>Dirección:</strong> <%= order.direccion_entrega || 'No disponible' %>
        </p>
        <% if (order.notas_especiales) { %>
            <p class="mb-0">
                <i class="fas fa-comment-alt text-primary me-2"></i>
                <strong>Notas:</strong> <%= order.notas_especiales %>
            </p>
        <% } %>
    </div>
</div>

<!-- Payment Info -->
<div class="payment-info mb-4">
    <h6 class="mb-3">Información de Pago</h6>
    <div class="p-3 bg-light rounded">
        <p class="mb-0">
            <i class="fas fa-credit-card text-primary me-2"></i>
            <strong>Método de Pago:</strong> 
            <%= order.metodo_pago ? 
                (order.metodo_pago === 'mercadopago' ? 'MercadoPago' :
                 order.metodo_pago === 'efectivo' ? 'Efectivo' :
                 order.metodo_pago === 'transferencia' ? 'Transferencia Bancaria' :
                 order.metodo_pago) : 'No disponible' %>
        </p>
    </div>
</div>

<!-- Order Timeline -->
<div class="order-timeline mb-4">
    <h6 class="mb-3">Estado del Pedido</h6>
    <div class="timeline">
        <% const estados = ['pendiente', 'confirmado', 'en_preparacion', 'en_camino', 'entregado'] %>
        <% estados.forEach((estado, index) => { %>
            <div class="timeline-item d-flex mb-3">
                <div class="timeline-icon me-3">
                    <div class="timeline-dot <%= order.estado === estado ? 'active' : 
                                               estados.indexOf(order.estado) > index ? 'completed' : '' %>">
                        <i class="fas fa-<%= estado === 'pendiente' ? 'clock' :
                                       estado === 'confirmado' ? 'check' :
                                       estado === 'en_preparacion' ? 'utensils' :
                                       estado === 'en_camino' ? 'truck' :
                                       'check-circle' %>"></i>
                    </div>
                    <% if (index < estados.length - 1) { %>
                        <div class="timeline-line"></div>
                    <% } %>
                </div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1"><%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %></h6>
                            <small class="text-muted">
                                <%= order.estado === estado ? 'Estado actual' :
                                   estados.indexOf(order.estado) > index ? 'Completado' :
                                   'Pendiente' %>
                            </small>
                        </div>
                        <% if (estados.indexOf(order.estado) === index - 1) { %>
                            <button type="button" 
                                    class="btn btn-sm btn-primary"
                                    data-order-id="<%= order.id %>"
                                    data-status="<%= estado %>"
                                    onclick="updateOrderStatus(this)">
                                Cambiar a <%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %>
                            </button>
                        <% } %>
                    </div>
                </div>
            </div>
        <% }) %>
    </div>
</div>

<!-- Action Buttons -->
<div class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-2"></i>Cerrar
    </button>
    <% if (order.estado === 'pendiente') { %>
        <button type="button"
                class="btn btn-primary"
                data-order-id="<%= order.id %>"
                data-status="confirmado"
                onclick="updateOrderStatus(this)">
            <i class="fas fa-check me-2"></i>Confirmar Pedido
        </button>
    <% } else if (order.estado === 'confirmado') { %>
        <button type="button"
                class="btn btn-primary"
                data-order-id="<%= order.id %>"
                data-status="en_preparacion"
                onclick="updateOrderStatus(this)">
            <i class="fas fa-utensils me-2"></i>Iniciar Preparación
        </button>
    <% } else if (order.estado === 'en_preparacion') { %>
        <button type="button"
                class="btn btn-primary"
                data-order-id="<%= order.id %>"
                data-status="en_camino"
                onclick="updateOrderStatus(this)">
            <i class="fas fa-truck me-2"></i>Enviar Pedido
        </button>
    <% } else if (order.estado === 'en_camino') { %>
        <button type="button"
                class="btn btn-success"
                data-order-id="<%= order.id %>"
                data-status="entregado"
                onclick="updateOrderStatus(this)">
            <i class="fas fa-check-circle me-2"></i>Marcar como Entregado
        </button>
    <% } %>
</div>

<script>
async function updateOrderStatus(button) {
    const orderId = button.dataset.orderId;
    const newStatus = button.dataset.status;
    
    if (!orderId || !newStatus) {
        showNotification('Error: datos del pedido no disponibles', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/dashboard/orders/${orderId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Cerrar el modal actual
            const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
            modal.hide();
            
            // Mostrar notificación
            showNotification('Estado del pedido actualizado', 'success');
            
            // Recargar la página después de un breve delay
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.message || 'Error al actualizar el estado', 'error');
        }
    } catch (error) {
        console.error('Error actualizando estado:', error);
        showNotification('Error al actualizar el estado del pedido', 'error');
    }
}
</script>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
}

.timeline-icon {
    position: absolute;
    left: -30px;
    top: 0;
    width: 30px;
    text-align: center;
}

.timeline-dot {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #e9ecef;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6c757d;
}

.timeline-dot.active {
    background-color: #0d6efd;
    color: white;
}

.timeline-dot.completed {
    background-color: #198754;
    color: white;
}

.timeline-line {
    position: absolute;
    left: 15px;
    top: 30px;
    bottom: -30px;
    width: 2px;
    background-color: #e9ecef;
}

.timeline-item:last-child .timeline-line {
    display: none;
}

.timeline-content {
    flex: 1;
}

.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
}

.btn-success {
    background-color: #198754;
    border-color: #198754;
}

.btn-success:hover {
    background-color: #157347;
    border-color: #146c43;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}

.btn-secondary:hover {
    background-color: #5c636a;
    border-color: #565e64;
}

.gap-2 {
    gap: 0.5rem !important;
}
</style> 