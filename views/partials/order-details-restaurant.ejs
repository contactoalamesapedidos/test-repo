<!-- Order Info -->
<div class="order-info mb-4">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h5 class="mb-1">Pedido #<%= order.numero_pedido %></h5>
            <p class="text-muted mb-0">
                <i class="fas fa-clock me-1"></i>
                <%= new Date(order.fecha_pedido).toLocaleString('es-AR') %>
            </p>
        </div>
        <span class="badge bg-<%= order.estado === 'pendiente' ? 'warning' :
                              order.estado === 'confirmado' ? 'info' :
                              order.estado === 'preparando' ? 'primary' :
                              order.estado === 'en_camino' ? 'secondary' :
                              order.estado === 'entregado' ? 'success' :
                              order.estado === 'cancelado' ? 'danger' : 'secondary' %>">
            <%= order.estado.charAt(0).toUpperCase() + order.estado.slice(1).replace('_', ' ') %>
        </span>
    </div>
</div>

<!-- Customer Info -->
<div class="customer-info mb-4">
    <h6 class="mb-3">Información del Cliente</h6>
    <div class="p-3 bg-light rounded">
        <p class="mb-2">
            <i class="fas fa-user text-primary me-2"></i>
            <strong>Cliente:</strong> <%= order.cliente_nombre %> <%= order.cliente_apellido %>
        </p>
        <p class="mb-0">
            <i class="fas fa-envelope text-primary me-2"></i>
            <strong>Email:</strong> <%= order.cliente_email %>
        </p>
    </div>
</div>

<!-- Order Items -->
<div class="order-items mb-4">
    <h6 class="mb-3">Productos</h6>
    <% if (items && items.length > 0) { %>
        <% items.forEach(item => { %>
            <div class="order-item d-flex align-items-center mb-3 p-3 border rounded">
                <img src="<%= item.imagen || '/images/no-image.png' %>" 
                     alt="<%= item.nombre || 'Producto' %>" 
                     class="rounded me-3" width="80" height="80"
                     style="object-fit: cover;">
                <div class="flex-grow-1">
                    <h6 class="mb-1"><%= item.nombre || 'Producto sin nombre' %></h6>
                    <% if (item.notas_especiales) { %>
                        <small class="text-muted d-block mb-1">
                            <i class="fas fa-comment-alt me-1"></i>
                            <%= item.notas_especiales %>
                        </small>
                    <% } %>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Cantidad: <%= item.cantidad || 0 %></span>
                        <strong>$<%= (Number(item.precio_unitario || 0) * Number(item.cantidad || 0)).toFixed(2) %></strong>
                    </div>
                </div>
            </div>
        <% }) %>
    <% } else { %>
        <div class="alert alert-info">
            No hay productos en este pedido
        </div>
    <% } %>
</div>

<!-- Order Summary -->
<div class="order-summary p-3 bg-light rounded mb-4">
    <h6 class="mb-3">Resumen del Pedido</h6>
    <div class="d-flex justify-content-between mb-2">
        <span>Subtotal:</span>
        <strong>$<%= Number(order.subtotal || 0).toFixed(2) %></strong>
    </div>
    <div class="d-flex justify-content-between mb-2">
        <span>Envío:</span>
        <strong>$<%= Number(order.costo_delivery || 0).toFixed(2) %></strong>
    </div>
    <hr>
    <div class="d-flex justify-content-between mb-2">
        <span class="fs-5">Total:</span>
        <strong class="fs-5 text-primary">$<%= Number(order.total || 0).toFixed(2) %></strong>
    </div>
</div>

<!-- Delivery Info -->
<div class="delivery-info mb-4">
    <h6 class="mb-3">Información de Entrega</h6>
    <div class="p-3 bg-light rounded">
        <p class="mb-2">
            <i class="fas fa-map-marker-alt text-primary me-2"></i>
            <strong>Dirección:</strong> <%= order.direccion_entrega || 'No disponible' %>
        </p>
        <% if (order.notas_especiales) { %>
            <p class="mb-0">
                <i class="fas fa-comment-alt text-primary me-2"></i>
                <strong>Notas:</strong> <%= order.notas_especiales %>
            </p>
        <% } %>
    </div>
</div>

<!-- Payment Info -->
<div class="payment-info mb-4">
    <h6 class="mb-3">Información de Pago</h6>
    <div class="p-3 bg-light rounded">
        <p class="mb-0">
            <i class="fas fa-credit-card text-primary me-2"></i>
            <strong>Método de Pago:</strong> 
            <%= order.metodo_pago ? 
                (order.metodo_pago === 'mercadopago' ? 'MercadoPago' :
                 order.metodo_pago === 'efectivo' ? 'Efectivo' :
                 order.metodo_pago === 'transferencia' ? 'Transferencia Bancaria' :
                 order.metodo_pago) : 'No disponible' %>
        </p>
    </div>
</div>

<!-- Order Timeline -->
<div class="order-timeline mb-4">
    <h6 class="mb-3">Estado del Pedido</h6>
    <div class="timeline">
        <% const estados = ['pendiente', 'confirmado', 'preparando', 'en_camino', 'entregado'] %>
        <% estados.forEach((estado, index) => { %>
            <div class="timeline-item d-flex mb-3">
                <div class="timeline-icon me-3">
                    <div class="timeline-dot <%= order.estado === estado ? 'active' : 
                                               estados.indexOf(order.estado) > index ? 'completed' : '' %>">
                        <i class="fas fa-<%= estado === 'pendiente' ? 'clock' :
                                       estado === 'confirmado' ? 'check' :
                    estado === 'preparando' ? 'utensils' :
                    estado === 'en_camino' ? 'truck' :
                    'check-circle' %>"></i>
                    </div>
                    <% if (index < estados.length - 1) { %>
                        <div class="timeline-line"></div>
                    <% } %>
                </div>
                <div class="timeline-content">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1"><%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %></h6>
                            <small class="text-muted">
                                <%= order.estado === estado ? 'Estado actual' :
                                   estados.indexOf(order.estado) > index ? 'Completado' :
                                   'Pendiente' %>
                            </small>
                        </div>
                        <% if (estados.indexOf(order.estado) === index - 1) { %>
                            <button type="button" 
                                    class="btn btn-sm btn-primary"
                                    data-order-id="<%= order.id %>"
                                    data-status="<%= estado %>"
                                    onclick="updateOrderStatusFromModal(this)">
                                Cambiar a <%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %>
                            </button>
                        <% } else if (estados.indexOf(order.estado) < index && index < estados.length - 1) { %>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-secondary" 
                                    disabled
                                    title="<%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %> - No disponible aún">
                                <%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %>
                            </button>
                        <% } %>
                    </div>
                </div>
            </div>
        <% }) %>
    </div>
</div>

<!-- Action Buttons -->
<div class="d-flex justify-content-end gap-2">
    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
        <i class="fas fa-times me-2"></i>Cerrar
    </button>
    
    <!-- Botones de estados - mostrar todos los futuros -->
    <% 
        const estados = ['pendiente', 'confirmado', 'en_camino', 'entregado'];
        const estadoActual = order.estado;
        const indiceActual = estados.indexOf(estadoActual);
    %>
    
    <!-- Botón Confirmar (si está pendiente) -->
    <% if (estadoActual === 'pendiente') { %>
        <button type="button"
                class="btn btn-success"
                data-order-id="<%= order.id %>"
                data-status="confirmado"
                onclick="updateOrderStatusFromModal(this)">
            <i class="fas fa-check me-2"></i>Confirmar Pedido
        </button>
        <button type="button"
                class="btn btn-danger ms-2"
                onclick="confirmCancelOrder('<%= order.id %>')">
            <i class="fas fa-times me-2"></i>Cancelar Pedido
        </button>
    <% } %>
    
    <!-- Botón Enviar Pedido (si está confirmado) -->
    <% if (estadoActual === 'confirmado' || estadoActual === 'preparando') { %>
        <button type="button"
                class="btn btn-warning"
                data-order-id="<%= order.id %>"
                data-status="en_camino"
                onclick="updateOrderStatusFromModal(this)">
            <i class="fas fa-truck me-2"></i>En Camino
        </button>
        <button type="button"
                class="btn btn-danger ms-2"
                onclick="confirmCancelOrder('<%= order.id %>')">
            <i class="fas fa-times me-2"></i>Cancelar Pedido
        </button>
    <% } %>
    
    <!-- Botón Marcar como Entregado (si está en camino) -->
    <% if (estadoActual === 'en_camino') { %>
        <button type="button"
                class="btn btn-success"
                data-order-id="<%= order.id %>"
                data-status="entregado"
                onclick="updateOrderStatusFromModal(this)">
            <i class="fas fa-check-circle me-2"></i>Marcar como Entregado
        </button>
        <button type="button"
                class="btn btn-danger ms-2"
                onclick="confirmCancelOrder('<%= order.id %>')">
            <i class="fas fa-times me-2"></i>Cancelar Pedido
        </button>
    <% } %>

<script>
function confirmCancelOrder(orderId) {
    if (confirm('¿Estás seguro de que deseas cancelar este pedido?')) {
        // Aquí deberías llamar a la función real de cancelación, por ejemplo:
        updateOrderStatusFromModal({
            dataset: { orderId: orderId, status: 'cancelado' }
        });
    }
}
</script>
    
    <!-- Mostrar botones futuros deshabilitados -->
    <% estados.forEach((estado, index) => { %>
        <% if (index > indiceActual && index < estados.length - 1) { %>
            <button type="button"
                    class="btn btn-outline-secondary" 
                    disabled
                    title="<%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %> - No disponible aún">
                <i class="fas fa-<%= 
                    estado === 'confirmado' ? 'check' :
                    estado === 'preparando' ? 'utensils' :
                    estado === 'en_camino' ? 'truck' :
                    'check-circle' %> me-2"></i>
                <%= estado.charAt(0).toUpperCase() + estado.slice(1).replace('_', ' ') %>
            </button>
        <% } %>
    <% }) %>
</div>

<!-- Chat Section -->
<div class="chat-section mt-4">
    <h6 class="mb-3">Chat del Pedido</h6>
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0 d-flex flex-column" style="height: 300px;">
            <div id="chatMessages" class="p-3 overflow-auto flex-grow-1">
                <!-- Los mensajes del chat se cargarán aquí -->
                <div class="text-center text-muted py-5">Cargando mensajes...</div>
            </div>
            <div class="chat-input border-top p-3 bg-light d-flex align-items-center">
                <input type="text" 
                       id="chatInput" 
                       class="form-control me-2" 
                       placeholder="Escribe un mensaje...">
                <button id="sendChatMessageBtn" 
                        class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Enviar
                </button>
            </div>
        </div>
    </div>
</div> 