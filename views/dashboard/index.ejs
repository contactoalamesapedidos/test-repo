<link rel="stylesheet" href="/css/dashboard-responsive.css">
<div class="container-fluid py-4">
    <!-- Banner de Restaurante -->
    <div class="card shadow-sm mb-4 position-relative overflow-hidden">
    <div class="banner-container position-relative" data-bg="<%= restaurant.imagen_banner ? (restaurant.imagen_banner.startsWith('/uploads') ? restaurant.imagen_banner : ('/uploads/' + restaurant.imagen_banner)) : '/images/no-image.png' %>" style="height: 250px; background-size: cover; background-position: center; z-index: 1;">
        <!-- Logo por encima del banner -->
        <img src="<%= restaurant.imagen_logo ? (restaurant.imagen_logo.startsWith('/uploads') ? restaurant.imagen_logo : ('/uploads/' + restaurant.imagen_logo)) : '/images/no-image.png' %>" class="rounded-circle border border-3 border-white shadow-lg restaurant-banner-logo" alt="Logo del Restaurante">
        <span class="badge <%= restaurant.abierto ? 'bg-success' : 'bg-danger' %> position-absolute restaurant-open-badge">
            <i class="fas fa-circle me-1"></i> <%= restaurant.abierto ? 'Abierto' : 'Cerrado' %>
        </span>
        <!-- Info superpuesta -->
        <div class="restaurant-banner-info">
            <h2 class="card-title mb-1"><%= restaurant.nombre %></h2>
            <p class="card-text text-muted mb-1"><%= restaurant.descripcion %></p>
            <span class="badge bg-light text-dark">
                <i class="far fa-clock me-1"></i> <%= (restaurant.horario_apertura||'').slice(0,5) %> - <%= (restaurant.horario_cierre||'').slice(0,5) %>
            </span>
        </div>
    </div>
    <div class="card-body p-3"></div>
</div>
<style>
@media (max-width: 576px) {
  .text-end .badge {
    white-space: normal !important;
    word-break: break-word;
    font-size: 1em !important;
    padding: 0.5em 0.7em !important;
    display: block;
    max-width: 100%;
    text-align: left;
  }
}
</style>

    <!-- Main content -->
    <div class="row">
        <div class="col-md-3 col-lg-2">
            <%- include('partials/sidebar', { activePage: 'dashboard' }) %>
        </div>

        <!-- Main content -->
        <div class="col-md-9 col-lg-10">
            <!-- Restaurant Status -->
            <% if (!restaurant.activo) { %>
                <div class="alert alert-danger text-center fw-bold mb-4">
                    Tu restaurante está cerrado por el administrador y no recibirá pedidos hasta que lo actives nuevamente.
                </div>
            <% } %>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Estadísticas
                </h2>
                <div class="d-flex align-items-center">
                    <button 
                        class="btn btn-sm <%= restaurant.activo ? 'btn-danger' : 'btn-success' %>"
                        data-restaurant-status="<%= restaurant.activo ? 'true' : 'false' %>"
                        onclick="toggleRestaurantStatus()"
                        title="<%= restaurant.activo ? 'Desactivar restaurante' : 'Activar restaurante' %>">
                        <i class="fas <%= restaurant.activo ? 'fa-power-off' : 'fa-play' %>"></i>
                        <span class="ms-1 d-none d-sm-inline"><%= restaurant.activo ? 'Desactivar' : 'Activar' %></span>
                    </button>
                </div>
            </div>

            <!-- Alerta de Repartidores Pendientes -->
            <% if (locals.pendingDriversCount && pendingDriversCount > 0) { %>
                <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
                    <span>
                        <i class="fas fa-motorcycle me-2"></i>
                        Tienes <strong><%= pendingDriversCount %></strong> nueva(s) solicitud(es) de repartidor pendiente(s).
                    </span>
                    <a href="/dashboard/driver-requests" class="btn btn-sm btn-primary">Ver Solicitudes</a>
                </div>
            <% } %>

            <!-- Stats cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-utensils text-warning fs-1 mb-2"></i>
                            <h3 class="card-title"><%= stats.total_productos %></h3>
                            <p class="card-text text-muted">Productos Activos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-receipt text-primary fs-1 mb-2"></i>
                            <h3 class="card-title"><%= stats.total_pedidos %></h3>
                            <p class="card-text text-muted">Pedidos Totales</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-dollar-sign text-success fs-1 mb-2"></i>
                            <h3 class="card-title"><%= new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(stats.ingresos_totales || 0) %></h3>
                            <p class="card-text text-muted">Ingresos Totales</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-concierge-bell text-info fs-1 mb-2"></i>
                            <h3 class="card-title"><%= stats.pedidos_pendientes %></h3>
                            <p class="card-text text-muted">Pedidos Pendientes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Earnings Stats -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-calendar-day text-primary fs-1 mb-2"></i>
                            <h3 class="card-title"><%= new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(dailyEarnings || 0) %></h3>
                            <p class="card-text text-muted">Ganancias Diarias</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-calendar-week text-info fs-1 mb-2"></i>
                            <h3 class="card-title"><%= new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(weeklyEarnings || 0) %></h3>
                            <p class="card-text text-muted">Ganancias Semanales</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-calendar-alt text-success fs-1 mb-2"></i>
                            <h3 class="card-title"><%= new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(monthlyEarnings || 0) %></h3>
                            <p class="card-text text-muted">Ganancias Mensuales</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick actions -->
            <div class="row mt-4">
                <div class="col-md-6 mb-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-plus-circle text-primary fs-1 mb-3"></i>
                            <h5>Agregar Producto</h5>
                            <p class="text-muted">Añade nuevos productos a tu menú</p>
                            <a href="/dashboard/products" class="btn btn-primary">
                                Gestionar Productos
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-3">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body text-center">
                            <i class="fas fa-cog text-secondary fs-1 mb-3"></i>
                            <h5>Configuración</h5>
                            <p class="text-muted">Actualiza información del restaurante</p>
                            <a href="/dashboard/settings" class="btn btn-secondary">
                                Configurar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<% if (user) { %>
  <script type="application/json" data-user>
    <%- JSON.stringify(user) %>
  </script>
<% } %>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Custom JavaScript -->
<!-- <script src="/js/app.js"></script> -->
<!-- <script src="/js/push-notifications.js"></script> -->
<% if (typeof scripts !== 'undefined' && scripts.length > 0) { %>
    <% scripts.forEach(script => { %>
        <script src="<%= script %>"></script>
    <% }); %>
<% } %>

<script>
// Verificar que los scripts se cargaron correctamente






document.addEventListener('DOMContentLoaded', function() {
    // Asegurar que el dropdown de usuario funcione
    const userDropdown = document.getElementById('userDropdown');
    if (userDropdown && typeof bootstrap !== 'undefined') {
        new bootstrap.Dropdown(userDropdown);
    }
    // Aplicar background del banner desde data-bg
    document.querySelectorAll('.banner-container[data-bg]').forEach(el => {
        const bg = el.getAttribute('data-bg');
        if (bg) el.style.backgroundImage = `url('${bg}')`;
    });

});

// Función para alternar el estado del restaurante
function toggleRestaurantStatus() {
    const button = event.target.closest('button');
    const currentStatus = button.getAttribute('data-restaurant-status') === 'true';
    const newStatus = !currentStatus;
    const action = newStatus ? 'activar' : 'desactivar';

    // Mostrar confirmación
    const confirmMessage = newStatus ?
        '¿Estás seguro de que quieres activar el restaurante? Los clientes podrán hacer pedidos.' :
        '¿Estás seguro de que quieres desactivar el restaurante? No recibirás nuevos pedidos.';

    if (!confirm(confirmMessage)) {
        return;
    }

    // Deshabilitar el botón mientras se procesa
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

    // Enviar solicitud al servidor
    fetch('/dashboard/toggle-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ accion: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar el botón
            button.setAttribute('data-restaurant-status', newStatus.toString());
            button.className = `btn btn-sm ${newStatus ? 'btn-danger' : 'btn-success'}`;
            button.innerHTML = `<i class="fas ${newStatus ? 'fa-power-off' : 'fa-play'}"></i><span class="ms-1 d-none d-sm-inline">${newStatus ? 'Desactivar' : 'Activar'}</span>`;
            button.setAttribute('title', newStatus ? 'Desactivar restaurante' : 'Activar restaurante');

            // Actualizar el badge de estado
            const badge = document.querySelector('.restaurant-open-badge');
            if (badge) {
                badge.className = `badge ${newStatus ? 'bg-success' : 'bg-danger'} position-absolute restaurant-open-badge`;
                badge.innerHTML = `<i class="fas fa-circle me-1"></i> ${newStatus ? 'Abierto' : 'Cerrado'}`;
            }

            // Mostrar mensaje de éxito
            alert(data.message);

            // Recargar la página para actualizar todos los elementos
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al cambiar el estado del restaurante. Por favor, inténtalo de nuevo.');
    })
    .finally(() => {
        // Rehabilitar el botón
        button.disabled = false;
        button.innerHTML = originalText;
    });
}
</script>
