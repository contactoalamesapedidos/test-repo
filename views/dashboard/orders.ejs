<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 col-md-3 col-lg-2 d-none d-md-block">
            <%- include('partials/sidebar', { activePage: 'pedidos' }) %>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Gestionar Pedidos</h2>
            </div>

            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <form action="/dashboard/orders" method="GET">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" name="status">
                                    <option value="">Todos los estados</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="confirmado">Confirmado</option>
                                    <option value="preparando">Preparando</option>
                                    <option value="en_camino">En Camino</option>
                                    <option value="entregado">Entregado</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" name="date" placeholder="Filtrar por fecha">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" name="search" placeholder="Buscar por número de pedido o cliente">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" type="submit">Filtrar</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Orders Section -->
            <div class="orders-cards-list d-md-none" id="pedidos-container">
                <% if (orders && orders.length > 0) { %>
                    <% orders.forEach(order => { %>
                        <div class="order-card-mobile" data-status="<%= order.estado %>" data-order-id="<%= order.id %>">
                            <div class="order-info">
                                <h5 class="order-title">Pedido #<%= order.numero_pedido %></h5>
                                <p class="order-restaurant"><%= order.cliente_nombre %> <%= order.cliente_apellido %></p>
                                <p class="order-meta"><%= new Date(order.fecha_pedido).toLocaleDateString() %> - <%= new Date(order.fecha_pedido).toLocaleTimeString() %></p>
                                <p class="card-text"><strong>Total:</strong> $<%= Number(order.total || 0).toFixed(2) %></p>
                            </div>
                            <div class="order-status-actions">
                                <div class="order-status-actions">
                                    <div class="d-flex justify-content-end align-items-center mb-2">
                                        <span class="badge bg-<%= order.estado === 'pendiente' ? 'warning' : 'info' %> order-badge me-2"><%= order.estado %></span>
                                        <button class="btn btn-sm btn-outline-primary me-2" data-action="show-details" data-order-id="<%= order.id %>" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                                        <button class="btn btn-sm btn-outline-info" data-action="open-chat" data-order-id="<%= order.id %>" title="Abrir Chat"><i class="fas fa-comment"></i></button>
                                    </div>
                                    <div class="d-flex justify-content-end align-items-center w-100">
                                        <% 
                                        const statusTransitions = {
                                            'pendiente': { next: 'confirmado', text: 'Aceptar', icon: 'fa-check', color: 'success' },
                                            'confirmado': { next: 'preparando', text: 'Preparar', icon: 'fa-hourglass-half', color: 'warning' },
                                            'preparando': { next: 'en_camino', text: 'En Camino', icon: 'fa-truck', color: 'primary' },
                                            'en_camino': { next: 'entregado', text: 'Entregado', icon: 'fa-check', color: 'success' }
                                        };
                                        const transition = statusTransitions[order.estado];
                                        if (transition) { %>
                                            <button class="btn btn-sm btn-<%= transition.color %> btn-action-text me-2" data-action="update-status" data-order-id="<%= order.id %>" data-status="<%= transition.next %>" title="<%= transition.text %> Pedido">
                                                <i class="fas <%= transition.icon %>"></i> <%= transition.text %>
                                            </button>
                                        <% } %>

                                        <% if (order.estado === 'pendiente') { %>
                                            <button class="btn btn-sm btn-danger btn-action-text" data-action="cancel-order" data-order-id="<%= order.id %>" title="Cancelar Pedido">
                                                <i class="fas fa-times"></i> Rechazar
                                            </button>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p class="text-muted">No hay pedidos activos.</p>
                <% } %>
            </div>

            <!-- Active Orders Section (Desktop) -->
            <div class="mt-4 d-none d-md-block">
                <h3 class="mb-4">Pedidos Activos</h3>
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-orders-dashboard">
                                <thead>
                                    <tr>
                                        <th># Pedido</th>
                                        <th>Cliente</th>
                                        <th>Fecha</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (orders && orders.length > 0) { %>
                                        <% orders.forEach(order => { %>
                                            <tr>
                                                <td><%= order.numero_pedido %></td>
                                                <td><%= order.cliente_nombre %> <%= order.cliente_apellido %></td>
                                                <td><%= new Date(order.fecha_pedido).toLocaleDateString() %></td>
                                                <td>$<%= Number(order.total || 0).toFixed(2) %></td>
                                                <td>
                                                    <span class="badge bg-<%= order.estado === 'pendiente' ? 'warning' : 
                                                                         order.estado === 'pendiente_pago' ? 'warning' :
                                                                         order.estado === 'confirmado' ? 'info' : 
                                                                         order.estado === 'preparando' ? 'primary' : 
                                                                         order.estado === 'en_camino' ? 'info' : 'secondary' %>">
                                                        <% if (order.estado === 'pendiente_pago') { %>
                                                            Pendiente de Pago
                                                        <% } else { %>
                                                            <%= order.estado.charAt(0).toUpperCase() + order.estado.slice(1).replace('_', ' ') %>
                                                        <% } %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-primary" data-action="show-details" data-order-id="<%= order.id %>" title="Ver Detalles">
                                                            <i class="fas fa-eye"></i> Ver
                                                        </button>
                                                        <button class="btn btn-sm btn-info" data-action="open-chat" data-order-id="<%= order.id %>" title="Abrir Chat">
                                                            <i class="fas fa-comment"></i> Chat
                                                        </button>
                                                        <% 
                                                        const statusTransitions = {
                                                            'pendiente': { next: 'confirmado', text: 'Aceptar', icon: 'fa-check', color: 'success' },
                                                            'confirmado': { next: 'preparando', text: 'Preparar', icon: 'fa-hourglass-half', color: 'warning' },
                                                            'preparando': { next: 'en_camino', text: 'En Camino', icon: 'fa-truck', color: 'primary' },
                                                            'en_camino': { next: 'entregado', text: 'Entregado', icon: 'fa-check', color: 'success' }
                                                        };
                                                        const transition = statusTransitions[order.estado];
                                                        if (transition) { %>
                                                            <button class="btn btn-sm btn-<%= transition.color %>" data-action="update-status" data-order-id="<%= order.id %>" data-status="<%= transition.next %>" title="<%= transition.text %> Pedido">
                                                                <i class="fas <%= transition.icon %>"></i> <%= transition.text %>
                                                            </button>
                                                        <% } %>
                                                        <% if (order.estado === 'pendiente') { %>
                                                            <button class="btn btn-sm btn-outline-danger" data-action="cancel-order" data-order-id="<%= order.id %>" title="Cancelar Pedido">
                                                                <i class="fas fa-times"></i> Cancelar
                                                            </button>
                                                        <% } %>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No hay pedidos activos.</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        <% if (totalPages > 1) { %>
                            <nav aria-label="Paginación de pedidos activos" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                                        <a class="page-link" href="?page=<%= currentPage - 1 %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <% for (let i = 1; i <= totalPages; i++) { %>
                                        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                            <a class="page-link" href="?page=<%= i %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>"><%= i %></a>
                                        </li>
                                    <% } %>
                                    <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                                        <a class="page-link" href="?page=<%= currentPage + 1 %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Historical Orders Section (Desktop) -->
            <div class="mt-5 d-none d-md-block">
                <h3 class="mb-4">Historial de Pedidos</h3>
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-orders-dashboard">
                                <thead>
                                    <tr>
                                        <th># Pedido</th>
                                        <th>Cliente</th>
                                        <th>Fecha</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (historicalOrders && historicalOrders.length > 0) { %>
                                        <% historicalOrders.forEach(order => { %>
                                            <tr>
                                                <td><%= order.numero_pedido %></td>
                                                <td><%= order.cliente_nombre %> <%= order.cliente_apellido %></td>
                                                <td><%= new Date(order.fecha_pedido).toLocaleDateString() %></td>
                                                <td>$<%= Number(order.total || 0).toFixed(2) %></td>
                                                <td>
                                                    <span class="badge bg-<%= order.estado === 'entregado' ? 'success' : 'danger' %>">
                                                        <%= order.estado %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" data-action="show-details" data-order-id="<%= order.id %>" title="Ver Detalles">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No hay pedidos en el historial.</td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        <% if (totalHistoricalPages > 1) { %>
                            <nav aria-label="Paginación historial de pedidos" class="mt-3">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item <%= historicalCurrentPage === 1 ? 'disabled' : '' %>">
                                        <a class="page-link" href="?historicalPage=<%= historicalCurrentPage - 1 %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>" aria-label="Anterior">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    <% for (let i = 1; i <= totalHistoricalPages; i++) { %>
                                        <li class="page-item <%= i === historicalCurrentPage ? 'active' : '' %>">
                                            <a class="page-link" href="?historicalPage=<%= i %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>"><%= i %></a>
                                        </li>
                                    <% } %>
                                    <li class="page-item <%= historicalCurrentPage === totalHistoricalPages ? 'disabled' : '' %>">
                                        <a class="page-link" href="?historicalPage=<%= historicalCurrentPage + 1 %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>" aria-label="Siguiente">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Historical Orders Section (Mobile) -->
            <div class="mt-5 d-md-none">
                <h3 class="mb-4">Historial de Pedidos</h3>
                <div class="orders-cards-list">
                    <% if (historicalOrders && historicalOrders.length > 0) { %>
                        <% historicalOrders.forEach(order => { %>
                            <div class="order-card-mobile" data-status="<%= order.estado %>" data-order-id="<%= order.id %>">
                                <div class="order-info">
                                    <h5 class="order-title">Pedido #<%= order.numero_pedido %></h5>
                                    <p class="order-restaurant"><%= order.cliente_nombre %> <%= order.cliente_apellido %></p>
                                    <p class="order-meta"><%= new Date(order.fecha_pedido).toLocaleDateString() %> - <%= new Date(order.fecha_pedido).toLocaleTimeString() %></p>
                                    <p class="card-text"><strong>Total:</strong> $<%= Number(order.total || 0).toFixed(2) %></p>
                                </div>
                                <div class="order-status-actions">
                                    <div class="d-flex justify-content-end align-items-center mb-2">
                                        <span class="badge bg-<%= order.estado === 'entregado' ? 'success' : 'danger' %> order-badge me-2"><%= order.estado %></span>
                                        <button class="btn btn-sm btn-outline-primary me-2" data-action="show-details" data-order-id="<%= order.id %>" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <p class="text-muted">No hay pedidos en el historial.</p>
                    <% } %>
                </div>
                <% if (totalHistoricalPages > 1) { %>
                    <nav aria-label="Paginación historial de pedidos" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <li class="page-item <%= historicalCurrentPage === 1 ? 'disabled' : '' %>">
                                <a class="page-link" href="?historicalPage=<%= historicalCurrentPage - 1 %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>" aria-label="Anterior">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            <% for (let i = 1; i <= totalHistoricalPages; i++) { %>
                                <li class="page-item <%= i === historicalCurrentPage ? 'active' : '' %>">
                                    <a class="page-link" href="?historicalPage=<%= i %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>"><%= i %></a>
                                </li>
                            <% } %>
                            <li class="page-item <%= historicalCurrentPage === totalHistoricalPages ? 'disabled' : '' %>">
                                <a class="page-link" href="?historicalPage=<%= historicalCurrentPage + 1 %>&status=<%= filtros.status %>&search=<%= filtros.search %>&date=<%= filtros.date %>" aria-label="Siguiente">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="orderDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body order-scroll" id="orderDetailModalBody" style="max-height: 70vh; overflow: scroll; overflow-x: auto; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="orderLocationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ubicación de Entrega</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="orderLocationMap" style="height:350px;"></div>
            </div>
        </div>
    </div>
</div>





<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin="" />

<!-- Socket.IO -->
<script src="/socket.io/socket.io.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script src="/js/dashboard/order-tracking-map.js"></script>
<script src="/js/dashboard-orders.js"></script>
<script src="/js/dashboard-orders-chat.js"></script>

<style>
.table-orders-dashboard th:nth-child(2),
.table-orders-dashboard td:nth-child(2) {
  width: 6%;
}
.table-orders-dashboard th:nth-child(3),
.table-orders-dashboard td:nth-child(3) {
  width: 3%;
}
</style>
