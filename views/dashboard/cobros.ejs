<%- include('../partials/header') %>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
          <span>Panel de Control</span>
        </h6>
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">
              <i class="fas fa-home me-2"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard/products">
              <i class="fas fa-utensils me-2"></i>Productos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard/orders">
              <i class="fas fa-shopping-cart me-2"></i>Pedidos
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/dashboard/cobros">
              <i class="fas fa-money-bill-wave me-2"></i>Mis Cobros
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
          <i class="fas fa-money-bill-wave me-2"></i>Mis Cobros y Comisiones
        </h1>
        <div class="d-flex align-items-center">
          <span class="badge bg-info me-3">
            <%= restaurant.nombre %>
          </span>
          <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver
          </a>
        </div>
      </div>

      <!-- Información del Sistema -->
      <div class="alert alert-info">
        <h6><i class="fas fa-info-circle me-2"></i>Sistema de Comisiones</h6>
        <p class="mb-2">
          <strong>A la Mesa</strong> cobra una comisión del <strong>10%</strong> sobre tus ventas brutas semanales. 
          Esto incluye todos los pedidos confirmados y entregados.
        </p>
        <p class="mb-0">
          <small>
            • Los cobros se generan automáticamente cada semana<br>
            • Tienes 7 días para realizar el pago desde la fecha de vencimiento<br>
            • Sube tu comprobante de pago para confirmar el pago
          </small>
        </p>
      </div>

      <!-- Resumen de Estado -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card border-0 bg-warning text-white">
            <div class="card-body text-center">
              <h3><%= cobros.filter(c => c.estado === 'pendiente').length %></h3>
              <small>Pendientes</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 bg-success text-white">
            <div class="card-body text-center">
              <h3><%= cobros.filter(c => c.estado === 'pagado').length %></h3>
              <small>Pagados</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 bg-danger text-white">
            <div class="card-body text-center">
              <h3><%= cobros.filter(c => c.estado === 'vencido').length %></h3>
              <small>Vencidos</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border-0 bg-info text-white">
            <div class="card-body text-center">
              <h3>$<%= Math.round(cobros.reduce((sum, c) => sum + parseFloat(c.monto_comision || 0), 0)).toLocaleString() %></h3>
              <small>Total Comisiones</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de Cobros -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="fas fa-list me-2"></i>
            Historial de Cobros
          </h6>
        </div>
        <div class="card-body p-0">
          <% if (cobros.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Período</th>
                    <th>Ventas Brutas</th>
                    <th>Comisión (10%)</th>
                    <th>Estado</th>
                    <th>Vencimiento</th>
                    <th>Comprobantes</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  <% cobros.forEach(cobro => { %>
                    <tr class="<%= cobro.estado === 'vencido' ? 'table-danger' : cobro.estado === 'pagado' ? 'table-success' : '' %>">
                      <td>
                        <div class="small">
                          <strong>Desde:</strong> <%= new Date(cobro.semana_inicio).toLocaleDateString('es-AR') %><br>
                          <strong>Hasta:</strong> <%= new Date(cobro.semana_fin).toLocaleDateString('es-AR') %>
                        </div>
                      </td>
                      <td>
                        <div class="text-end">
                          <strong class="text-primary">$<%= cobro.ventas_brutas.toLocaleString() %></strong>
                        </div>
                      </td>
                      <td>
                        <div class="text-end">
                          <strong class="text-danger">$<%= cobro.monto_comision.toLocaleString() %></strong>
                          <br><small class="text-muted"><%= cobro.porcentaje_comision %>%</small>
                        </div>
                      </td>
                      <td>
                        <% if (cobro.estado === 'pendiente') { %>
                          <span class="badge bg-warning">Pendiente</span>
                          <% if (new Date(cobro.fecha_vencimiento) < new Date()) { %>
                            <br><span class="badge bg-danger mt-1">Vencido</span>
                          <% } %>
                        <% } else if (cobro.estado === 'pagado') { %>
                          <span class="badge bg-success">Pagado</span>
                          <% if (cobro.fecha_pago) { %>
                            <br><small class="text-muted">
                              <%= new Date(cobro.fecha_pago).toLocaleDateString('es-AR') %>
                            </small>
                          <% } %>
                        <% } else if (cobro.estado === 'vencido') { %>
                          <span class="badge bg-danger">Vencido</span>
                        <% } else if (cobro.estado === 'exonerado') { %>
                          <span class="badge bg-secondary">Exonerado</span>
                        <% } %>
                      </td>
                      <td>
                        <div class="small">
                          <%= new Date(cobro.fecha_vencimiento).toLocaleDateString('es-AR') %>
                          <% const diasRestantes = Math.ceil((new Date(cobro.fecha_vencimiento) - new Date()) / (1000 * 60 * 60 * 24)); %>
                          <% if (diasRestantes > 0 && cobro.estado === 'pendiente') { %>
                            <br><small class="text-info">
                              <i class="fas fa-clock"></i> <%= diasRestantes %> día<%= diasRestantes > 1 ? 's' : '' %> restante<%= diasRestantes > 1 ? 's' : '' %>
                            </small>
                          <% } else if (diasRestantes <= 0 && cobro.estado === 'pendiente') { %>
                            <br><small class="text-danger">
                              <i class="fas fa-exclamation-triangle"></i> Vencido
                            </small>
                          <% } %>
                        </div>
                      </td>
                      <td>
                        <% if (cobro.comprobantes_count > 0) { %>
                          <span class="badge bg-info">
                            <%= cobro.comprobantes_count %> subido<%= cobro.comprobantes_count > 1 ? 's' : '' %>
                          </span>
                          <% if (cobro.monto_pagado_aprobado > 0) { %>
                            <br><small class="text-success">
                              $<%= cobro.monto_pagado_aprobado.toLocaleString() %> aprobado
                            </small>
                          <% } %>
                        <% } else { %>
                          <span class="badge bg-light text-dark">Sin comprobantes</span>
                        <% } %>
                      </td>
                      <td>
                        <div class="btn-group">
                          <a href="/dashboard/cobros/<%= cobro.id %>" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Ver
                          </a>
                          <% if (cobro.estado === 'pendiente') { %>
                            <button class="btn btn-sm btn-success" onclick="subirComprobante(<%= cobro.id %>)">
                              <i class="fas fa-upload"></i> Pagar
                            </button>
                          <% } %>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-5">
              <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
              <h5>No tienes cobros registrados</h5>
              <p class="text-muted">Los cobros aparecerán aquí cuando tengas ventas semanales</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Comprobantes Recientes -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <h6 class="mb-0">
            <i class="fas fa-receipt me-2"></i>
            Comprobantes Recientes
          </h6>
        </div>
        <div class="card-body p-0">
          <% if (comprobantes.length > 0) { %>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Período</th>
                    <th>Método de Pago</th>
                    <th>Monto</th>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Archivo</th>
                  </tr>
                </thead>
                <tbody>
                  <% comprobantes.forEach(comp => { %>
                    <tr>
                      <td>
                        <small>
                          <%= new Date(comp.semana_inicio).toLocaleDateString('es-AR') %> - 
                          <%= new Date(comp.semana_fin).toLocaleDateString('es-AR') %>
                        </small>
                      </td>
                      <td>
                        <div class="text-capitalize">
                          <%= comp.metodo_pago.replace('_', ' ') %>
                          <% if (comp.referencia_pago) { %>
                            <br><small class="text-muted">Ref: <%= comp.referencia_pago %></small>
                          <% } %>
                        </div>
                      </td>
                      <td>
                        <strong>$<%= comp.monto_pagado.toLocaleString() %></strong>
                        <% if (comp.monto_pagado < comp.monto_comision) { %>
                          <br><small class="text-warning">Pago parcial</small>
                        <% } %>
                      </td>
                      <td>
                        <small><%= new Date(comp.fecha_subida).toLocaleDateString('es-AR') %></small>
                      </td>
                      <td>
                        <% if (comp.estado === 'pendiente') { %>
                          <span class="badge bg-warning">En revisión</span>
                        <% } else if (comp.estado === 'aprobado') { %>
                          <span class="badge bg-success">Aprobado</span>
                        <% } else if (comp.estado === 'rechazado') { %>
                          <span class="badge bg-danger">Rechazado</span>
                        <% } %>
                      </td>
                      <td>
                        <a href="/uploads/comprobantes/<%= comp.archivo_comprobante %>" 
                           target="_blank" class="btn btn-sm btn-outline-primary">
                          <i class="fas fa-file-alt"></i>
                        </a>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <div class="text-center py-4">
              <i class="fas fa-receipt fa-2x text-muted mb-2"></i>
              <p class="text-muted">No has subido comprobantes aún</p>
            </div>
          <% } %>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modal Subir Comprobante -->
<div class="modal fade" id="modalSubirComprobante" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-upload me-2"></i>Subir Comprobante de Pago
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formSubirComprobante" enctype="multipart/form-data">
          <input type="hidden" id="cobro_id" name="cobro_id">
          
          <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Información del Cobro</h6>
            <div id="info_cobro"></div>
          </div>
          
          <div class="row g-3">
            <div class="col-md-6">
              <label for="metodo_pago" class="form-label">Método de Pago *</label>
              <select class="form-select" id="metodo_pago" name="metodo_pago" required>
                <option value="">Selecciona el método</option>
                <option value="transferencia">Transferencia Bancaria</option>
                <option value="deposito">Depósito Bancario</option>
                <option value="mercadopago">MercadoPago</option>
                <option value="efectivo">Efectivo</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="referencia_pago" class="form-label">Referencia/Número</label>
              <input type="text" class="form-control" id="referencia_pago" name="referencia_pago" 
                     placeholder="Número de transferencia, etc.">
            </div>
            <div class="col-md-6">
              <label for="monto_pagado" class="form-label">Monto Pagado *</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" id="monto_pagado" name="monto_pagado" 
                       step="0.01" min="0" required>
              </div>
            </div>
            <div class="col-md-6">
              <label for="fecha_pago_declarada" class="form-label">Fecha de Pago *</label>
              <input type="date" class="form-control" id="fecha_pago_declarada" name="fecha_pago_declarada" required>
            </div>
            <div class="col-12">
              <label for="comprobante" class="form-label">Archivo del Comprobante *</label>
              <input type="file" class="form-control" id="comprobante" name="comprobante" 
                     accept=".jpg,.jpeg,.png,.pdf" required>
              <div class="form-text">Formatos permitidos: JPG, PNG, PDF. Máximo 10MB.</div>
            </div>
            <div class="col-12">
              <label for="comentarios_restaurante" class="form-label">Comentarios (opcional)</label>
              <textarea class="form-control" id="comentarios_restaurante" name="comentarios_restaurante" 
                        rows="3" placeholder="Agregar comentarios adicionales..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="enviarComprobante()">
          <i class="fas fa-upload me-1"></i>Subir Comprobante
        </button>
      </div>
    </div>
  </div>
</div>

<script>
function subirComprobante(cobroId) {
  // Find cobro data
  const cobros = <%- JSON.stringify(cobros) %>;
  const cobro = cobros.find(c => c.id === cobroId);
  
  if (!cobro) {
    showNotification('Cobro no encontrado', 'error');
    return;
  }
  
  // Set cobro ID
  document.getElementById('cobro_id').value = cobroId;
  
  // Set default amount
  document.getElementById('monto_pagado').value = cobro.monto_comision;
  
  // Set today as default date
  document.getElementById('fecha_pago_declarada').value = new Date().toISOString().split('T')[0];
  
  // Update info panel
  document.getElementById('info_cobro').innerHTML = `
    <strong>Período:</strong> ${new Date(cobro.semana_inicio).toLocaleDateString('es-AR')} - ${new Date(cobro.semana_fin).toLocaleDateString('es-AR')}<br>
    <strong>Ventas del período:</strong> $${parseFloat(cobro.ventas_brutas).toLocaleString()}<br>
    <strong>Comisión a pagar:</strong> $${parseFloat(cobro.monto_comision).toLocaleString()}<br>
    <strong>Vencimiento:</strong> ${new Date(cobro.fecha_vencimiento).toLocaleDateString('es-AR')}
  `;
  
  // Show modal
  new bootstrap.Modal(document.getElementById('modalSubirComprobante')).show();
}

function enviarComprobante() {
  const form = document.getElementById('formSubirComprobante');
  const formData = new FormData(form);
  const cobroId = formData.get('cobro_id');
  
  if (!formData.get('metodo_pago') || !formData.get('monto_pagado') || 
      !formData.get('fecha_pago_declarada') || !formData.get('comprobante')) {
    showNotification('Por favor, completa todos los campos requeridos', 'warning');
    return;
  }
  
  fetch(`/dashboard/cobros/${cobroId}/comprobante`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification(data.message, 'success');
      bootstrap.Modal.getInstance(document.getElementById('modalSubirComprobante')).hide();
      setTimeout(() => location.reload(), 1500);
    } else {
      showNotification(data.message || 'Error subiendo comprobante', 'error');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('Error subiendo comprobante', 'error');
  });
}

// Notification system
function showNotification(message, type) {
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'} border-0`;
  toast.setAttribute('role', 'alert');
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;
  
  // Add to container
  let container = document.querySelector('.toast-container');
  if (!container) {
    container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(container);
  }
  
  container.appendChild(toast);
  new bootstrap.Toast(toast).show();
  
  // Remove after 5 seconds
  setTimeout(() => {
    if (toast.parentNode) {
      toast.parentNode.removeChild(toast);
    }
  }, 5000);
}
</script>

<%- include('../partials/footer') %>
