<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12 col-md-3 col-lg-2 d-none d-md-block">
            <%- include('partials/sidebar', { activePage: 'conductores' }) %>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10">
        <div class="row">
            <div class="col-12">
                <div class="card my-4">
                    <div class="card-header p-0 position-relative mt-n4 mx-3 z-index-2">
                        <div class="bg-gradient-primary shadow-primary border-radius-lg pt-4 pb-3">
                            <div class="d-flex justify-content-between align-items-center px-3">
                                <h6 class="text-dark text-capitalize mb-0">Gestión de Repartidores</h6>
                                <button class="btn btn-sm btn-success mb-0 shadow-sm" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                                    <i class="fas fa-plus me-1"></i>Nuevo Repartidor
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body px-4 pb-2">
                        <!-- Filtros y búsqueda -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-2">
                                <div class="input-group input-group-outline">
                                    <label class="form-label">Buscar repartidor...</label>
                                    <input type="text" id="searchDriver" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <select id="statusFilter" class="form-select">
                                    <option value="">Todos los estados</option>
                                    <option value="available">Disponible</option>
                                    <option value="on_delivery">En reparto</option>
                                    <option value="offline">Desconectado</option>
                                </select>
                            </div>
                            <div class="col-md-2 text-md-end mb-2">
                                <button class="btn btn-outline-primary btn-sm" id="resetFilters">
                                    <i class="fas fa-redo me-1"></i> Reiniciar
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table align-items-center mb-0">
                                <thead>
                                    <tr>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Repartidor</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Contacto</th>
                                        <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Vehículo</th>
                                        <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Estado</th>
                                        <th class="text-secondary opacity-7 text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="driversTableBody">
                                    <% if (drivers.length > 0) { %>
                                        <% drivers.forEach(driver => { %>
                                            <tr class="driver-row" data-status="<%= driver.status %>" data-name="<%= driver.nombre.toLowerCase() %> <%= driver.apellido.toLowerCase() %>" data-vehicle="<%= driver.vehicle_type.toLowerCase() %>">
                                                <td data-label="Repartidor">
                                                    <div class="d-flex px-2 py-1">
                                                        <div>
                                                            <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                                                <i class="fas fa-user fa-sm"></i>
                                                            </div>
                                                        </div>
                                                        <div class="d-flex flex-column justify-content-center">
                                                            <h6 class="mb-0 text-sm">
                                                                <%= driver.nombre %> <%= driver.apellido %>
                                                            </h6>
                                                            <span class="text-xs text-secondary">ID: <%= driver.user_id %></span>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td data-label="Contacto">
                                                    <p class="text-xs text-secondary mb-0"><i class="fas fa-envelope me-1"></i> <%= driver.email %></p>
                                                    <p class="text-xs text-secondary mb-0"><i class="fas fa-phone me-1"></i> <%= driver.telefono || 'No especificado' %></p>
                                                </td>
                                                <td data-label="Vehículo">
                                                    <div class="d-flex flex-column">
                                                        <span class="text-xs font-weight-bold mb-1"><i class="fas fa-<%= driver.vehicle_type === 'Moto' ? 'motorcycle' : 'car' %> me-1"></i> <%= driver.vehicle_type %></span>
                                                        <% if (driver.vehicle_plate) { %>
                                                            <span class="badge badge-sm bg-gradient-secondary"><%= driver.vehicle_plate %></span>
                                                        <% } %>
                                                    </div>
                                                </td>
                                                <td data-label="Estado" class="align-middle text-center text-sm">
                                                    <span class="badge badge-sm bg-gradient-<%= driver.status === 'available' ? 'success' : (driver.status === 'on_delivery' ? 'warning' : 'secondary') %> d-inline-flex align-items-center">
                                                        <i class="fas fa-<%= driver.status === 'available' ? 'check-circle' : (driver.status === 'on_delivery' ? 'truck' : 'times-circle') %> me-1" style="font-size: 1rem;"></i>
                                                        <%= driver.status === 'available' ? 'Disponible' : (driver.status === 'on_delivery' ? 'En Reparto' : 'Desconectado') %>
                                                    </span>
                                                    <% if (driver.last_activity) { %>
                                                        <p class="text-xs text-secondary mb-0 mt-1">Últ. conexión: <%= new Date(driver.last_activity).toLocaleString() %></p>
                                                    <% } %>
                                                </td>
                                                <td data-label="Acciones" class="align-middle text-center">
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-link text-success mb-0 px-1 py-0"
                                                                onclick="window.location.href='/dashboard/driver/<%= driver.user_id %>'"
                                                                title="Ver perfil del repartidor">
                                                            <i class="fas fa-user text-sm"></i>
                                                        </button>
                                                        <button class="btn btn-link text-danger mb-0 px-1 py-0 delete-driver-btn"
                                                                data-id="<%= driver.id %>"
                                                                data-name="<%= driver.nombre %> <%= driver.apellido %>"
                                                                title="Eliminar repartidor">
                                                            <i class="fas fa-trash text-sm"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }) %>
                                    <% } else { %>
                                        <tr>
                                            <td colspan="5" class="text-center py-4">
                                                <i class="fas fa-motorcycle fa-3x text-secondary mb-3"></i>
                                                <h6 class="text-muted">No hay repartidores registrados</h6>
                                                <p class="text-sm text-muted mb-0">Comienza agregando tu primer repartidor</p>
                                                <button class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                                                    <i class="fas fa-user-plus me-1"></i>Agregar Repartidor
                                                </button>
                                            </td>
                                        </tr>
                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Versión Móvil -->
                        <div class="d-md-none mt-4">
                            <h6 class="text-uppercase text-secondary font-weight-bolder mb-3">Repartidores</h6>
                            <% if (drivers.length > 0) { %>
                                <div class="row g-3" style="margin-bottom: 1rem;">
                                    <% drivers.forEach(driver => { %>
                                        <div class="col-12">
                                            <div class="card driver-card-mobile shadow-sm" data-status="<%= driver.status %>" data-name="<%= driver.nombre.toLowerCase() %> <%= driver.apellido.toLowerCase() %>">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-start">
                                                        <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                                            <i class="fas fa-user"></i>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <div class="d-flex justify-content-between align-items-start">
                                                                <div>
                                                                    <h6 class="mb-0 text-sm"><%= driver.nombre %> <%= driver.apellido %></h6>
                                                                    <p class="text-xs text-secondary mb-1"><i class="fas fa-<%= driver.vehicle_type === 'Moto' ? 'motorcycle' : 'car' %> me-1"></i> <%= driver.vehicle_type %></p>
                                                                </div>
                                                                <span class="badge badge-sm bg-gradient-<%= driver.status === 'available' ? 'success' : (driver.status === 'on_delivery' ? 'warning' : 'secondary') %>">
                                                                    <%= driver.status === 'available' ? 'Disponible' : (driver.status === 'on_delivery' ? 'En Reparto' : 'Desconectado') %>
                                                                </span>
                                                            </div>
                                                            <p class="text-xs text-secondary mb-1"><i class="fas fa-envelope me-1"></i> <%= driver.email %></p>
                                                            <p class="text-xs text-secondary mb-0"><i class="fas fa-phone me-1"></i> <%= driver.telefono || 'Sin teléfono' %></p>
                                                            
                                                            <div class="d-flex justify-content-end mt-2">
                                                                <button class="btn btn-sm btn-link text-success p-0 me-2"
                                                                        onclick="window.location.href='/dashboard/driver/<%= driver.user_id %>'"
                                                                        title="Ver perfil del repartidor">
                                                                    <i class="fas fa-user" style="font-size: 1.2rem;"></i>
                                                                </button>
                                                                <button class="btn btn-sm btn-link text-danger p-0 delete-driver-btn"
                                                                        data-id="<%= driver.id %>"
                                                                        data-name="<%= driver.nombre %> <%= driver.apellido %>"
                                                                        title="Eliminar repartidor">
                                                                    <i class="fas fa-trash" style="font-size: 1.2rem;"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <% }) %>
                                </div>
                            <% } else { %>
                                <div class="text-center py-5">
                                    <i class="fas fa-motorcycle fa-3x text-secondary mb-3"></i>
                                    <h6 class="text-muted">No hay repartidores</h6>
                                    <p class="text-sm text-muted mb-0">Comienza agregando tu primer repartidor</p>
                                    <button class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addDriverModal">
                                        <i class="fas fa-user-plus me-1" style="font-size: 1rem;"></i>Agregar Repartidor
                                    </button>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        </div>
    </div>
</div>

<!-- Script para filtrado y búsqueda -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchDriver');
        const statusFilter = document.getElementById('statusFilter');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const driverRows = document.querySelectorAll('.driver-row, .driver-card-mobile');
        
        // Función para filtrar repartidores
        function filterDrivers() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;
            let visibleCount = 0;
            
            driverRows.forEach(row => {
                const name = row.getAttribute('data-name') || '';
                const status = row.getAttribute('data-status') || '';
                const vehicle = row.getAttribute('data-vehicle') || '';
                
                const matchesSearch = name.includes(searchTerm) || 
                                    vehicle.includes(searchTerm) ||
                                    row.textContent.toLowerCase().includes(searchTerm);
                                    
                const matchesStatus = !statusValue || status === statusValue;
                
                if (matchesSearch && matchesStatus) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Mostrar mensaje si no hay resultados
            const noResults = document.getElementById('noResults');
            if (visibleCount === 0) {
                if (!noResults) {
                    const tbody = document.querySelector('#driversTableBody');
                    if (tbody) {
                        const tr = document.createElement('tr');
                        tr.id = 'noResults';
                        tr.innerHTML = `
                            <td colspan="5" class="text-center py-4">
                                <i class="fas fa-search fa-2x text-secondary mb-2"></i>
                                <h6 class="text-muted">No se encontraron resultados</h6>
                                <p class="text-sm text-muted mb-0">Intenta con otros términos de búsqueda o filtros</p>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
            } else if (noResults) {
                noResults.remove();
            }
        }
        
        // Event listeners
        if (searchInput) searchInput.addEventListener('input', filterDrivers);
        if (statusFilter) statusFilter.addEventListener('change', filterDrivers);
        
        if (resetFiltersBtn) {
            resetFiltersBtn.addEventListener('click', function() {
                if (searchInput) searchInput.value = '';
                if (statusFilter) statusFilter.value = '';
                filterDrivers();
            });
        }
        
        // Inicializar tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Inicializar popovers
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
        
        // Manejar eliminación de repartidor
        document.addEventListener('click', function(e) {
            if (e.target.closest('.delete-driver-btn')) {
                const button = e.target.closest('.delete-driver-btn');
                const driverId = button.getAttribute('data-id');
                const driverName = button.getAttribute('data-name') || 'este repartidor';
                
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: `¿Deseas eliminar a ${driverName}? Esta acción no se puede deshacer.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Aquí iría la llamada AJAX para eliminar el repartidor
                        fetch(`/dashboard/drivers/${driverId}/delete`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Eliminar la fila de la tabla
                                const row = button.closest('tr, .driver-card-mobile').parentNode;
                                if (row) {
                                    row.remove();
                                    
                                    // Mostrar mensaje de éxito
                                    Swal.fire(
                                        '¡Eliminado!',
                                        `El repartidor ${driverName} ha sido eliminado.`,
                                        'success'
                                    );
                                    
                                    // Actualizar contadores
                                    updateCounters();
                                }
                            } else {
                                Swal.fire(
                                    'Error',
                                    'No se pudo eliminar el repartidor. Por favor, inténtalo de nuevo.',
                                    'error'
                                );
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire(
                                'Error',
                                'Ocurrió un error al intentar eliminar el repartidor.',
                                'error'
                            );
                        });
                    }
                });
            }
        });
        
        // Función para actualizar los contadores
        function updateCounters() {
            const totalDrivers = document.querySelectorAll('.driver-row, .driver-card-mobile').length;
            const availableDrivers = document.querySelectorAll('[data-status="available"]').length;
            const onDeliveryDrivers = document.querySelectorAll('[data-status="on_delivery"]').length;
            
            // Actualizar los contadores en la interfaz
            const totalCounter = document.querySelector('.card.bg-gradient-primary h4');
            const availableCounter = document.querySelector('.card.bg-gradient-success h4');
            const onDeliveryCounter = document.querySelector('.card.bg-gradient-warning h4');
            
            if (totalCounter) totalCounter.textContent = totalDrivers;
            if (availableCounter) availableCounter.textContent = availableDrivers;
            if (onDeliveryCounter) onDeliveryCounter.textContent = onDeliveryDrivers;
        }
    });
</script>

<!-- Add Driver Modal -->
<div class="modal fade" id="addDriverModal" tabindex="-1" role="dialog" aria-labelledby="addDriverModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDriverModalLabel">Añadir Nuevo Repartidor</h5>
                <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addDriverForm">
                    <div class="mb-3">
                        <label for="addDriverNombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="addDriverNombre" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDriverApellido" class="form-label">Apellido</label>
                        <input type="text" class="form-control" id="addDriverApellido" name="apellido" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDriverEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="addDriverEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDriverPassword" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="addDriverPassword" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="addDriverTelefono" class="form-label">Teléfono (Opcional)</label>
                        <input type="text" class="form-control" id="addDriverTelefono" name="telefono">
                    </div>
                    <div class="mb-3">
                        <label for="addDriverVehicleType" class="form-label">Tipo de Vehículo</label>
                        <select class="form-select" id="addDriverVehicleType" name="vehicle_type" required>
                            <option value="">Seleccione...</option>
                            <option value="moto">Moto</option>
                            <option value="bicicleta">Bicicleta</option>
                            <option value="auto">Auto</option>
                            <option value="a_pie">A pie</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Añadir Repartidor</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Driver Modal -->
<div class="modal fade" id="editDriverModal" tabindex="-1" role="dialog" aria-labelledby="editDriverModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDriverModalLabel">Editar Repartidor</h5>
                <button type="button" class="btn-close text-dark" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editDriverForm">
                    <input type="hidden" id="editDriverId" name="id">
                    <div class="mb-3">
                        <label for="editDriverNombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="editDriverNombre" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDriverApellido" class="form-label">Apellido</label>
                        <input type="text" class="form-control" id="editDriverApellido" name="apellido" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDriverEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editDriverEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDriverTelefono" class="form-label">Teléfono (Opcional)</label>
                        <input type="text" class="form-control" id="editDriverTelefono" name="telefono">
                    </div>
                    <div class="mb-3">
                        <label for="editDriverVehicleType" class="form-label">Tipo de Vehículo</label>
                        <select class="form-select" id="editDriverVehicleType" name="vehicle_type" required>
                            <option value="">Seleccione...</option>
                            <option value="moto">Moto</option>
                            <option value="bicicleta">Bicicleta</option>
                            <option value="auto">Auto</option>
                            <option value="a_pie">A pie</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editDriverStatus" class="form-label">Estado</label>
                        <select class="form-select" id="editDriverStatus" name="status" required>
                            <option value="available">Disponible</option>
                            <option value="on_delivery">En Reparto</option>
                            <option value="offline">Desconectado</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>
<script src="/js/dashboard/dashboard-drivers.js"></script>
<%- include('partials/restaurant-mobile-nav', { activePage: 'drivers' }) %>
