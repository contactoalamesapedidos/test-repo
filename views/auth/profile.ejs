<% // Header ya incluido en layout.ejs %>
<div class="container py-4">
    <div class="row">
        <!-- Perfil -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);">
                    <h5 class="mb-0 d-flex align-items-center gap-2">
                        <i class="fas fa-user me-2"></i>
                        Mi Perfil
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <div class="form-check form-switch m-0 d-flex align-items-center" title="Notificaciones de nuevos pedidos">
                            <input class="form-check-input" type="checkbox" id="pushNotificationsSwitch" style="cursor:pointer">
                            <label class="form-check-label ms-2" for="pushNotificationsSwitch">
                                <i class="fas fa-bell"></i>
                            </label>
                        </div>
                        <button id="editProfileBtn" class="btn btn-light btn-sm" title="Editar perfil" type="button">
                            <i class="fas fa-pen"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="pushPermissionHelp" class="alert alert-warning d-none" role="alert">
                        Las notificaciones están bloqueadas para este sitio. Para activarlas:
                        <ul class="mb-0 mt-2">
                            <li>Haz clic en el candado de la barra de direcciones y permite "Notificaciones".</li>
                            <li>En Chrome/Edge: Configuración del sitio → Permisos → Notificaciones → Permitir.</li>
                            <li>En Windows: Configuración → Sistema → Notificaciones → activa notificaciones del navegador.</li>
                        </ul>
                    </div>
                    <form id="profileForm" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nombre" class="form-label">Nombre *</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" 
                                       value="<%= user.nombre %>" required>
                            </div>
                            <div class="col-md-6">
                                <label for="apellido" class="form-label">Apellido *</label>
                                <input type="text" class="form-control" id="apellido" name="apellido" 
                                       value="<%= user.apellido %>" required>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="<%= user.email %>" required>
                            </div>
                            <div class="col-md-6">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="telefono" name="telefono" 
                                       value="<%= user.telefono || '' %>">
                            </div>
                            <div class="col-md-6">
                                <label for="ciudad" class="form-label">Ciudad</label>
                                <input type="text" class="form-control" id="ciudad" name="ciudad" value="<%= user.ciudad || '' %>">
                            </div>
                            <div class="col-md-6">
                                <label for="direccion" class="form-label">Dirección <small class="text-muted">(opcional)</small></label>
                                <input type="text" class="form-control" id="direccion" name="direccion" value="<%= user.direccion_principal || '' %>" maxlength="255" placeholder="Tu dirección completa">
                            </div>
                            <div class="col-12">
                                <hr>
                                <div class="form-check form-switch mb-3" title="Notificaciones por email">
                                    <input class="form-check-input" type="checkbox" id="recibirNotificaciones" name="recibir_notificaciones" <%= user.recibir_notificaciones ? 'checked' : '' %> />
                                    <label class="form-check-label" for="recibirNotificaciones">
                                        Recibir notificaciones por email
                                    </label>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        Miembro desde <%= new Date(user.fecha_registro).toLocaleDateString('es-AR') %>
                                    </small>
                                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; border: none;">
                                        <i class="fas fa-save me-2"></i>
                                        Guardar Cambios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div id="profileView">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Nombre</label>
                                <div><%= user.nombre %></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Apellido</label>
                                <div><%= user.apellido %></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Email</label>
                                <div><%= user.email %></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Teléfono</label>
                                <div><%= user.telefono || '-' %></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Ciudad</label>
                                <div><%= user.ciudad || '-' %></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Dirección</label>
                                <div><%= user.direccion_principal || '-' %></div>
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                Miembro desde <%= new Date(user.fecha_registro).toLocaleDateString('es-AR') %>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de Cambio de Contraseña -->
        <div class="col-lg-8 mt-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header text-white d-flex justify-content-between align-items-center" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>
                        Cambiar Contraseña
                    </h5>
                    <button id="editPasswordBtn" class="btn btn-light btn-sm" title="Editar contraseña" type="button">
                        <i class="fas fa-pen"></i>
                    </button>
                </div>
                <div class="card-body">
                    <form id="changePasswordForm" action="/auth/change-password" method="POST">
                        <!-- CSRF Token -->
                        <input type="hidden" name="_csrf" value="<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>">

                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="current_password" class="form-label">Contraseña Actual *</label>
                                <input type="password" class="form-control" id="current_password" name="current_password" required disabled>
                            </div>
                            <div class="col-md-6">
                                <label for="new_password" class="form-label">Nueva Contraseña *</label>
                                <input type="password" class="form-control" id="new_password" name="new_password" minlength="6" required disabled>
                            </div>
                            <div class="col-md-6">
                                <label for="confirm_new_password" class="form-label">Confirmar Nueva Contraseña *</label>
                                <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" minlength="6" required disabled>
                            </div>
                            <div class="col-12 text-end">
                                <button id="savePasswordBtn" type="submit" class="btn" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; border: none;" disabled>
                                    <i class="fas fa-save me-2"></i>
                                    Actualizar Contraseña
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pedidos Recientes -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);">
                    <h5 class="mb-0">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Pedidos Recientes
                    </h5>
                </div>
                <div class="card-body p-0">
                    <% if (orders && orders.length > 0) { %>
                        <div class="list-group list-group-flush">
                            <% orders.forEach(order => { %>
                                <a href="/orders/<%= order.id %>" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1">#<%= order.numero_pedido %></h6>
                                            <small class="text-muted">
                                                <%= order.restaurante_nombre %>
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge status-<%= order.estado %>">
                                                <%= order.estado.charAt(0).toUpperCase() + order.estado.slice(1) %>
                                            </span>
                                            <div class="mt-1">
                                                <small class="text-muted">
                                                    $<%= parseFloat(order.total).toFixed(2) %>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            <% }); %>
                        </div>
                        <div class="card-footer bg-transparent text-center">
                            <a href="/orders/history" class="btn btn-outline-primary btn-sm" style="border-color: #ff6b35; color: #ff6b35;">
                                Ver Todos los Pedidos
                            </a>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-shopping-cart text-muted fs-1 mb-3"></i>
                            <p class="text-muted">No tienes pedidos recientes</p>
                            <a href="/restaurants" class="btn btn-sm" style="background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%); color: white; border: none;">
                                <i class="fas fa-utensils me-2"></i>
                                Ver Restaurantes
                            </a>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Switch movido al header de la tarjeta de perfil -->

<script>
document.addEventListener('DOMContentLoaded', async function() {
  // Inicializar switch push según suscripción existente
  const switchElem = document.getElementById('pushNotificationsSwitch');
  const help = document.getElementById('pushPermissionHelp');

  if (switchElem && 'serviceWorker' in navigator && 'PushManager' in window) {
    // Verificar permisos del navegador
    if (typeof Notification !== 'undefined' && Notification.permission === 'denied') {
      // Mostrar ayuda si ya está denegado el permiso
      if (help) help.classList.remove('d-none');
      switchElem.checked = false;
      switchElem.disabled = false; // Permitimos click para reintentar tras habilitar en navegador
    }

    // Inicializar el servicio de notificaciones push
    if (window.pushNotificationService) {
      await window.pushNotificationService.initialize();

      // Verificar si hay suscripción activa
      const hasSubscription = window.pushNotificationService.isEnabled();
      switchElem.checked = hasSubscription;

      console.log('[PROFILE] Switch inicializado:', hasSubscription ? 'ON' : 'OFF');
    }

    // Bind handler
    switchElem.addEventListener('change', () => togglePushNotifications(switchElem));
  }
});

document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Disable submit button and show loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
    
    try {
        // Crear URLSearchParams para enviar como form data
        const formData = new URLSearchParams();
        formData.append('nombre', form.nombre.value);
        formData.append('apellido', form.apellido.value);
        formData.append('email', form.email.value);
        formData.append('telefono', form.telefono.value);
        formData.append('ciudad', form.ciudad.value);
        formData.append('direccion', form.direccion.value);
        if (form.recibir_notificaciones && form.recibir_notificaciones.checked) {
            formData.append('recibir_notificaciones', 'on');
        }
        
        const response = await fetch('/auth/profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: formData.toString()
        });
        
        if (response.ok) {
            showNotification('Perfil actualizado exitosamente', 'success');
            
            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showNotification('Error actualizando el perfil', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error actualizando el perfil', 'error');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';
    }
});

document.getElementById('editProfileBtn').addEventListener('click', function() {
    document.getElementById('profileForm').style.display = 'block';
    document.getElementById('profileView').style.display = 'none';
});

// Habilitar/Deshabilitar edición de contraseña
document.getElementById('editPasswordBtn').addEventListener('click', function() {
  const form = document.getElementById('changePasswordForm');
  const inputs = form.querySelectorAll('input[type="password"]');
  const saveBtn = document.getElementById('savePasswordBtn');
  const enable = inputs[0].disabled; // si está deshabilitado, habilitamos
  inputs.forEach(i => i.disabled = !enable ? true : false);
  saveBtn.disabled = !enable ? true : false;
  // Alternamos: si estaba deshabilitado ahora habilitamos
  if (enable) {
    inputs.forEach(i => i.disabled = false);
    saveBtn.disabled = false;
    this.innerHTML = '<i class="fas fa-times"></i>'; // icono cancelar
    this.title = 'Cancelar';
  } else {
    inputs.forEach(i => { i.disabled = true; i.value = ''; });
    saveBtn.disabled = true;
    this.innerHTML = '<i class="fas fa-pen"></i>';
    this.title = 'Editar contraseña';
  }
});

// Función para mostrar notificaciones
function showNotification(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        document.body.removeChild(toast);
    });
}

async function togglePushNotifications(checkbox) {
  // Validaciones básicas
  if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
    showNotification('Tu navegador no soporta notificaciones push.', 'danger');
    checkbox.checked = false;
    return;
  }

  // Verificar que el servicio esté disponible
  if (!window.pushNotificationService) {
    showNotification('Servicio de notificaciones no disponible.', 'danger');
    checkbox.checked = false;
    return;
  }

  try {
    if (checkbox.checked) {
      // Activar notificaciones
      console.log('[PROFILE] Activando notificaciones push...');

      // Inicializar el servicio si no está inicializado
      await window.pushNotificationService.initialize();

      // Verificar si ya está habilitado
      if (window.pushNotificationService.isEnabled()) {
        showNotification('Las notificaciones push ya están activadas.', 'info');
        return;
      }

      // Solicitar permisos y suscribir
      await window.pushNotificationService.requestPermission();

      showNotification('Notificaciones push activadas exitosamente.', 'success');
      console.log('[PROFILE] Notificaciones activadas correctamente');

    } else {
      // Desactivar notificaciones
      console.log('[PROFILE] Desactivando notificaciones push...');

      await window.pushNotificationService.unsubscribe();

      showNotification('Notificaciones push desactivadas.', 'info');
      console.log('[PROFILE] Notificaciones desactivadas correctamente');
    }
  } catch (error) {
    console.error('[PROFILE] Error toggling push notifications:', error);

    // Revertir el estado del checkbox en caso de error
    checkbox.checked = !checkbox.checked;

    // Mostrar mensaje de error específico
    if (error.message.includes('denegado') || error.message.includes('denied')) {
      showNotification('Permiso denegado. Habilita las notificaciones en la configuración del navegador.', 'warning');
      const help = document.getElementById('pushPermissionHelp');
      if (help) help.classList.remove('d-none');
    } else {
      showNotification('Error al cambiar el estado de las notificaciones: ' + error.message, 'danger');
    }
  }
}
</script>

<style>
.toast.position-fixed {
  z-index: 10800 !important;
}
</style>
<% // Footer ya incluido en layout.ejs %>
